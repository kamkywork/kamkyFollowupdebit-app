<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î - Collection System (V.48 Final Perfect)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* =========================================================================
           CORE STYLES
           ========================================================================= */
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #2ec4b6;
            --warning: #ff9f1c;
            --danger: #e71d36;
            --dark: #2b2d42;
            --light: #f8f9fa;
            --gray: #8d99ae;
            --bg: #edf2f4;
            --card-radius: 16px;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--dark); -webkit-font-smoothing: antialiased; }
        
        /* Header */
        .header { background: #ffffff; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header h2 { margin: 0; font-size: 20px; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 8px; }
        .tools-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .tools-bar::-webkit-scrollbar { display: none; }
        .date-input { border: 1px solid #e0e0e0; background: #f9f9f9; padding: 8px 12px; border-radius: 10px; min-width: 130px; font-family: 'Sarabun'; }
        
        /* Buttons */
        .btn-icon, .btn-pill { border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-icon { width: 38px; height: 38px; flex-shrink: 0; }
        .btn-pill { padding: 8px 15px; font-size: 13px; font-weight: 600; gap: 5px; border-radius: 20px; white-space: nowrap; }
        .btn-icon:hover, .btn-pill:hover { transform: translateY(-2px); }
        .btn-refresh { background: var(--warning); }
        .btn-print { background: var(--dark); }
        .btn-excel { background: #20bf6b; }
        .btn-reset { background: var(--gray); }
        .btn-daily { background: linear-gradient(135deg, #ff9f43, #ee5253); }
        .btn-monthly { background: linear-gradient(135deg, #54a0ff, #5f27cd); }

        /* Dashboard */
        .perf-container { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: white; border-radius: var(--card-radius); padding: 20px; box-shadow: var(--shadow); }
        .stat-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 600; color: var(--gray); }
        .chart-box { height: 140px; position: relative; margin-bottom: 15px; }
        .stat-footer { display: flex; justify-content: space-between; background: #f8faff; padding: 10px 15px; border-radius: 12px; }
        .stat-item h4 { margin: 0; font-size: 16px; color: var(--dark); }
        .stat-item span { font-size: 11px; color: var(--gray); }

        /* List & Card */
        .list-container { padding: 0 20px 80px 20px; max-width: 800px; margin: 0 auto; }
        .section-title { font-size: 14px; color: var(--gray); margin-bottom: 10px; font-weight: 600; padding-left: 5px; }
        .cust-card { border-radius: var(--card-radius); margin-bottom: 20px; box-shadow: var(--shadow); position: relative; overflow: visible; border-left: 5px solid transparent; transition: transform 0.2s; background: white; }
        .card-normal { border-left-color: #ddd; }
        .card-postpone { background: #fbf5ff; border-left-color: #9b59b6; }
        .card-overdue { background: #fff0f0; border-left-color: #e74c3c; }
        .card-pending-approve { background: #fffdf5; border-left-color: #ffca28; } 

        .cust-header { padding: 15px 15px 5px 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .cust-info { flex: 1; min-width: 0; }
        .cust-info h3 { margin: 0 0 4px 0; font-size: 17px; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cust-id { font-size: 11px; color: var(--gray); background: rgba(0,0,0,0.03); padding: 3px 8px; border-radius: 6px; display: inline-block; border: 1px solid rgba(0,0,0,0.05); }
        .status-badge { text-align: right; margin-left: 10px; flex-shrink: 0; }
        .status-text { font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .text-red { color: #c0392b; } .text-purple { color: #8e44ad; } .text-green { color: #27ae60; } .text-orange { color: #f39c12; }
        .btn-kebab { border: none; background: transparent; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--gray); }
        
        .cust-body { padding: 0 15px 15px 15px; display: flex; justify-content: space-between; align-items: flex-end; margin-top: 5px;}
        .contact-line { font-size: 13px; color: #555; display: flex; align-items: center; gap: 6px; margin-top: 5px; }
        .amount-val { font-size: 22px; font-weight: 800; color: var(--dark); letter-spacing: -0.5px; }

        /* Action Buttons */
        .cust-actions { 
            padding: 10px 15px; background: rgba(245, 247, 250, 0.5); 
            border-top: 1px solid rgba(0,0,0,0.05); 
            display: grid; gap: 10px; 
            border-bottom-left-radius: var(--card-radius); border-bottom-right-radius: var(--card-radius); 
        }
        .btn-act { border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; height: 40px; }
        .btn-act-call { background: white; color: var(--secondary); border: 1px solid #e0e0e0; text-decoration: none; }
        .btn-act-postpone { background: white; color: #7e22ce; border: 1px solid #e0e0e0; }
        .btn-act-pay { background: var(--dark); color: white; }
        .btn-act-contract { background: #34495e; color: white; } 
        .user-checkbox-btn { background: white; border: 1px solid #ddd; color: #555; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; justify-content: flex-start; transition: 0.2s; height: 40px; }
        .user-checkbox-btn:active { background: #eef2ff; border-color: var(--primary); color: var(--primary); }
        .loading-state { text-align: center; padding: 40px; color: var(--gray); }

        /* Mobile Styles */
        @media (max-width: 600px) {
            .perf-container { grid-template-columns: 1fr; gap: 15px; padding: 15px; }
            .header { padding: 15px; }
            /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Grid 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ó‡∏£‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
            .grid-user-actions, .grid-admin-actions { grid-template-columns: 1fr 1fr !important; }
            .btn-act, .user-checkbox-btn { width: 100%; box-sizing: border-box; }
        }

        /* Login */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(43, 45, 66, 0.98); z-index: 9000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px 25px; border-radius: 15px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .user-profile-badge { font-size: 11px; background: #eef3ff; color: var(--primary); padding: 3px 8px; border-radius: 15px; margin-left: 8px; cursor: pointer; border: 1px solid #dce6ff; display: inline-flex; align-items: center; gap: 4px; }
        .hidden-elm { display: none !important; }
    </style>
</head>
<body>

    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--dark); margin-bottom:20px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <input type="text" id="loginUser" class="login-input" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <input type="password" id="loginPass" class="login-input" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" onkeyup="if(event.key==='Enter') doLogin()">
            <div style="display:flex; justify-content:space-between; font-size:13px; color:#666; margin-bottom:15px;">
                <label style="cursor:pointer;"><input type="checkbox" id="rememberMe"> ‡∏à‡∏î‡∏à‡∏≥‡∏â‡∏±‡∏ô</label>
                <span style="color:var(--primary); cursor:pointer;" onclick="forgotPass()">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</span>
            </div>
            <button class="btn-pill" style="background:var(--primary); width:100%; justify-content:center; padding:12px; font-size:16px;" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            <div id="loginMsg" style="color:red; margin-top:15px; font-size:13px; min-height:20px;"></div>
        </div>
    </div>

    <div class="header">
        <div class="header-top">
            <h2 id="appTitle"><i class="fas fa-chart-pie"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î</h2>
            <span id="currentTime" style="font-size:12px; color:var(--gray);"></span>
        </div>
        <div class="tools-bar">
            <input type="date" id="filterDate" class="date-input" onchange="loadData()">
            <button class="btn-icon btn-refresh" onclick="loadData()"><i class="fas fa-sync-alt"></i></button>
            <button class="btn-pill btn-daily" onclick="showSummary('daily')"><i class="fas fa-bolt"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô</button>
            <button class="btn-pill btn-monthly" onclick="showSummary('monthly')"><i class="fas fa-calendar-check"></i> ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            <button id="btnPrint" class="btn-icon btn-print" onclick="printReport()"><i class="fas fa-print"></i></button>
            <button id="btnExcel" class="btn-icon btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i></button>
            <button id="btnReset" class="btn-icon btn-reset" onclick="resetHidden()"><i class="fas fa-eye"></i></button>
            <button id="btnAdmin" class="btn-icon" style="background:#2c3e50; display:none;" onclick="manageUsers()" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"><i class="fas fa-users-cog"></i></button>
        </div>
    </div>

    <div class="perf-container">
        <div class="stat-card">
            <div class="stat-header"><span><i class="fas fa-sun" style="color:#ff9f43"></i> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><span id="txtTodayPercent" style="color:var(--success)">0%</span></div>
            <div class="chart-box"><canvas id="dailyChart"></canvas></div>
            <div class="stat-footer">
                <div class="stat-item"><span>‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</span><h4 id="txtTodayCollected">0</h4></div>
                <div class="stat-item" style="text-align:right"><span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span><h4 id="txtTodayPending">0</h4></div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-header"><span><i class="fas fa-calendar" style="color:#54a0ff"></i> ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span><span id="txtMonthPercent" style="color:var(--secondary)">0%</span></div>
            <div class="chart-box"><canvas id="monthlyChart"></canvas></div>
            <div class="stat-footer">
                <div class="stat-item"><span>‡∏™‡∏∞‡∏™‡∏°</span><h4 id="txtMonthCollected">0</h4></div>
                <div class="stat-item" style="text-align:right"><span>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span><h4 id="txtMonthTarget">0</h4></div>
            </div>
        </div>
    </div>

    <div class="list-container">
        <div class="section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (Follow up)</div>
        <div id="contractList"></div>
    </div>

    <script>
        // üî¥üî¥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á üî¥üî¥
        const API_URL = 'https://script.google.com/macros/s/AKfycbxDMvreshnIijn3vAg5ERXWOVD7amaW8mZy94azIcriQiQOqaAixnTuMfVEw0QZlj18/exec'; 
        
        let currentUser = null;
        
        window.onload = function() {
            const saved = localStorage.getItem('kamky_user');
            if (saved) { currentUser = JSON.parse(saved); initApp(); } 
            else { document.getElementById('filterDate').valueAsDate = new Date(); }
        };

        async function doLogin() {
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            const rem = document.getElementById('rememberMe').checked;
            const msg = document.getElementById('loginMsg');
            
            if(!u || !p) { msg.innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; return; }
            msg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            msg.style.color = 'var(--primary)';
            
            try {
                const res = await fetch(API_URL, { 
                    method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({action:'login', username:u, password:p}) 
                });
                
                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                const d = await res.json();
                
                if(d.status === 'success') {
                    currentUser = d.user;
                    if(rem) localStorage.setItem('kamky_user', JSON.stringify(currentUser));
                    Swal.fire({ icon: 'success', title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', text: `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${currentUser.name}`, timer: 1000, showConfirmButton: false }).then(() => initApp());
                } else {
                    msg.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${d.message || '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'}`;
                    msg.style.color = 'red';
                }
            } catch(e) { 
                console.error(e);
                msg.innerText = ''; 
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå API ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Deploy as Anyone)', footer: `<small style="color:red">${e.message}</small>` });
            }
        }

        function initApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appTitle').innerHTML += ` <span class="user-profile-badge" onclick="userProfile()"><i class="fas fa-user"></i> ${currentUser.name}</span>`;
            if(!document.getElementById('filterDate').value) document.getElementById('filterDate').valueAsDate = new Date();
            const isUser = currentUser.role !== 'admin';
            if (isUser) { document.getElementById('btnPrint').style.display = 'none'; document.getElementById('btnExcel').style.display = 'none'; document.getElementById('btnReset').style.display = 'none'; } 
            else { document.getElementById('btnAdmin').style.display = 'flex'; }
            loadData();
        }

        function userProfile() { Swal.fire({ title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', html: `<b>${currentUser.name}</b><br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${currentUser.role}`, showDenyButton: true, confirmButtonText: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', denyButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', denyButtonColor: '#d33' }).then(r => { if(r.isConfirmed) changePass(); else if(r.isDenied) { localStorage.removeItem('kamky_user'); location.reload(); } }); }
        async function changePass() { const { value: p } = await Swal.fire({ title: '‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà', input: 'password' }); if(p) { await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'change_password', username:currentUser.username, new_pass:p}) }); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } }
        async function forgotPass() { const steps = ['Username', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå']; const inputs = []; for(let s of steps) { const {value:v} = await Swal.fire({title:'‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', text:'‡∏£‡∏∞‡∏ö‡∏∏ '+s, input:'text', showCancelButton:true, zIndex:10000}); if(!v) return; inputs.push(v); } const {value:nP} = await Swal.fire({title:'‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà', input:'password', zIndex:10000}); if(nP) { Swal.fire({title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen:()=>Swal.showLoading(), zIndex:10000}); const res = await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'reset_password_via_phone', username:inputs[0], phone:inputs[1], new_pass:nP}) }); const d = await res.json(); Swal.fire({ title: d.status==='success'?'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à':'‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: d.message||'', icon: d.status==='success'?'success':'error', zIndex:10000 }); } }

        async function manageUsers() {
            Swal.fire({ title:'Loading...', didOpen:()=>Swal.showLoading() });
            const r = await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'get_users'}) }); const d = await r.json();
            let h = `<div style="text-align:right; margin-bottom:10px;"><button onclick="addUser()" style="background:#28a745; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div>`;
            h += `<div style="overflow-x:auto;"><table style="width:100%; text-align:left; font-size:13px; border-collapse:collapse; white-space:nowrap;"><tr style="background:#eee;"><th style="padding:5px;">User</th><th style="padding:5px;">Role</th><th style="padding:5px;">Edit</th></tr>`;
            d.users.forEach(u => { let color = u.role === 'admin' ? 'red' : 'green'; h += `<tr style="border-bottom:1px solid #ddd;"><td style="padding:5px;">${u.username}</td><td style="padding:5px; color:${color}; font-weight:bold;">${u.role}</td><td style="padding:5px;"><button onclick="editRole('${u.username}', '${u.role}')" style="cursor:pointer; font-size:12px;">‚öôÔ∏è</button></td></tr>`; });
            h += `</table></div>`;
            Swal.fire({ title:'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', html:h, width:500, showConfirmButton:false, showCloseButton:true });
        }
        async function editRole(user, currentRole) { const { value: newRole } = await Swal.fire({ title: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${user}`, input: 'select', inputOptions: { 'user': 'User', 'admin': 'Admin' }, inputValue: currentRole, showCancelButton: true }); if (newRole) { Swal.showLoading(); await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'update_user', target_username:user, role:newRole}) }); Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢').then(()=>manageUsers()); } }
        async function addUser() { const { value: v } = await Swal.fire({ html: '<input id="u" placeholder="User" class="swal2-input"><input id="p" placeholder="Pass" class="swal2-input"><input id="n" placeholder="Name" class="swal2-input"><input id="t" placeholder="Tel" class="swal2-input">', preConfirm: () => [document.getElementById('u').value, document.getElementById('p').value, document.getElementById('n').value, document.getElementById('t').value] }); if(v) { await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'add_user', username:v[0], password:v[1], name:v[2], role:'user', position:'Staff', tel:v[3]}) }); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à').then(()=>manageUsers()); } }

        let currentTrackingData = [], filteredData = [], globalSummary = {};
        let dailyChartInstance = null, monthlyChartInstance = null;
        function formatDateToThai(dateString) { if(!dateString) return ""; const p = dateString.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
        
        async function loadData() {
            const date = document.getElementById('filterDate').value;
            const container = document.getElementById('contractList');
            container.innerHTML = '<div class="loading-state"><i class="fas fa-circle-notch fa-spin"></i><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_tracking', date: date }) });
                const data = await response.json();
                currentTrackingData = data.contracts || []; globalSummary = data.summary || {};
                renderDashboard(data, date);
            } catch (e) { container.innerHTML = '<div class="loading-state" style="color:var(--danger)">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>'; }
        }

        function renderDashboard(data, selectedDate) {
            const container = document.getElementById('contractList'); container.innerHTML = "";
            const hidden = JSON.parse(localStorage.getItem('hiddenContracts') || '[]').map(String);
            const selectedDateThai = formatDateToThai(selectedDate);
            const isAdmin = currentUser.role === 'admin';
            filteredData = []; let pendingToday = 0;

            if (data.contracts) {
                data.contracts.forEach(c => {
                    if (hidden.includes(String(c.c_no))) return;
                    const hasPost = (c.postpone_date && c.postpone_date !== "-" && c.postpone_date !== "");
                    let show = (hasPost && c.postpone_date === selectedDateThai) || (!hasPost && (c.due_date === selectedDateThai || c.overdue_count > 0));
                    if (show) {
                        let amt = parseFloat(c.amount) * (c.overdue_count > 1 ? c.overdue_count : 1);
                        pendingToday += amt;
                        filteredData.push({ ...c, finalAmount: amt, hasPostpone: hasPost });
                    }
                });
            }

            const colToday = data.summary.total_collected_today || 0; const targetToday = colToday + pendingToday;
            updateChart('dailyChart', 'daily', colToday, pendingToday);
            document.getElementById('txtTodayCollected').innerText = colToday.toLocaleString();
            document.getElementById('txtTodayPending').innerText = pendingToday.toLocaleString();
            document.getElementById('txtTodayPercent').innerText = `${Math.round(targetToday > 0 ? (colToday/targetToday)*100 : 0)}%`;
            const colMonth = data.summary.total_collected_month || 0; const targetMonth = data.summary.expected_month || data.summary.total_expected_month || 0;
            updateChart('monthlyChart', 'monthly', colMonth, Math.max(0, targetMonth - colMonth));
            document.getElementById('txtMonthCollected').innerText = colMonth.toLocaleString();
            document.getElementById('txtMonthTarget').innerText = targetMonth.toLocaleString();

            if (filteredData.length === 0) { container.innerHTML = '<div class="loading-state"><i class="fas fa-check-circle" style="color:var(--success)"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>'; return; }

            filteredData.forEach(c => {
                let cardClass = "card-normal"; let statusHtml = `<span class="status-text text-green"><i class="fas fa-check-circle"></i> ‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
                if (c.status === 'Pending_Approve' || c.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') { cardClass = "card-pending-approve"; statusHtml = `<span class="status-text text-orange"><i class="fas fa-clock"></i> ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>`; } 
                else if (c.hasPostpone) { cardClass = "card-postpone"; statusHtml = `<span class="status-text text-purple"><i class="fas fa-clock"></i> ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô: ${c.postpone_date}</span>`; } 
                else if (c.overdue_count > 0) { cardClass = "card-overdue"; statusHtml = `<span class="status-text text-red"><i class="fas fa-exclamation-circle"></i> ‡∏Ñ‡πâ‡∏≤‡∏á ${c.overdue_count} ‡∏á‡∏ß‡∏î</span>`; }

                let menuButton = ''; if (isAdmin) menuButton = `<button class="btn-kebab" style="margin-left:5px;" onclick="openManageMenu(${c.row_index},'${c.b_name}','${c.c_no}')"><i class="fas fa-ellipsis-v"></i></button>`;
                
                let actionButtonsHtml = ''; let gridClass = '';
                if (isAdmin) {
                    gridClass = 'grid-admin-actions';
                    actionButtonsHtml = `
                        <a href="tel:${c.b_mobile}" class="btn-act btn-act-call"><i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£</a>
                        <button class="btn-act btn-act-postpone" onclick="openPostpone(${c.row_index},'${c.b_name}','${c.postpone_date||''}')"><i class="fas fa-clock"></i> ‡∏ô‡∏±‡∏î</button>
                        <button class="btn-act btn-act-pay" onclick="openPay('${c.c_no}')"><i class="fas fa-wallet"></i> ‡∏à‡πà‡∏≤‡∏¢</button>
                        <button class="btn-act btn-act-contract" onclick="openContractPopup('${c.c_no}')"><i class="fas fa-file-contract"></i> ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</button>
                    `;
                } else {
                    gridClass = 'grid-user-actions';
                    // üü¢ ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ó‡∏£‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô
                    actionButtonsHtml = `
                        <a href="tel:${c.b_mobile}" class="btn-act btn-act-call"><i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£</a>
                        <button class="btn-act btn-act-contract" onclick="openContractPopup('${c.c_no}')"><i class="fas fa-file-contract"></i> ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</button>
                        <button class="user-checkbox-btn" onclick="userReqPay('${c.c_no}')"><i class="far fa-square"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button class="user-checkbox-btn" onclick="userReqPostpone('${c.c_no}')"><i class="far fa-square"></i> ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î</button>
                        <button class="user-checkbox-btn" style="grid-column: span 2;" onclick="userAddNote('${c.c_no}')"><i class="fas fa-pen"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</button>
                    `;
                }

                let desktopGridStyle = isAdmin ? 'grid-template-columns: 1fr 1fr 1fr 1fr;' : 'grid-template-columns: 1fr 1fr;';

                container.innerHTML += `
                <div class="cust-card ${cardClass}">
                    <div class="cust-header">
                        <div class="cust-info"><h3>${c.b_name}</h3><span class="cust-id">#${c.c_no}</span></div>
                        <div class="status-badge">${statusHtml}</div>${menuButton}
                    </div>
                    <div class="cust-body">
                        <div><div class="contact-line"><i class="fas fa-phone-alt fa-fw"></i> ${c.b_mobile || '-'}</div><div class="contact-line"><i class="fas fa-list-ol fa-fw"></i> ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${c.installment_no}</div></div>
                        <div style="text-align:right"><span style="font-size:10px; color:#777; display:block;">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span><span class="amount-val">‡∏ø${c.finalAmount.toLocaleString()}</span></div>
                    </div>
                    <div class="cust-actions ${gridClass}" style="${desktopGridStyle}">${actionButtonsHtml}</div>
                </div>`;
            });
        }

        async function openContractPopup(cNo) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤...', html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
            try {
                const res = await fetch(API_URL, { method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action: 'get_contract_image', c_no: cNo }) });
                if (!res.ok) throw new Error('Network error'); const data = await res.json();
                if (data.status === 'success') {
                    Swal.fire({ title: `‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${cNo}`, imageUrl: data.url, imageAlt: 'Contract Image', width: '95%', padding: '10px', showCloseButton: true, confirmButtonText: '‡∏õ‡∏¥‡∏î' });
                } else { Swal.fire({ icon: 'warning', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå', text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡πÉ‡∏ô Drive (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤)' }); }
            } catch (e) { Swal.fire({ icon: 'error', title: 'Error', text: 'Connection failed: ' + e.message }); }
        }

        async function userReqPay(cNo) {
            const { value: formValues } = await Swal.fire({ title: '‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', html: `<p style="font-size:13px; color:#666;">‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ Admin ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p><label><input type="checkbox" id="swal-pay-check" checked> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</label><input id="swal-pay-note" class="swal2-input" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏≠‡∏ô)">`, focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á', preConfirm: () => [document.getElementById('swal-pay-check').checked, document.getElementById('swal-pay-note').value] });
            if (formValues && formValues[0]) sendUserRequest('request_pay', cNo, { note: formValues[1] });
        }
        async function userReqPostpone(cNo) { const { value: date } = await Swal.fire({ title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î', input: 'date', showCancelButton: true, confirmButtonText: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' }); if (date) { const { value: note } = await Swal.fire({ input: 'text', title: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', placeholder: '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•...', showCancelButton: true }); if(note !== undefined) sendUserRequest('request_postpone', cNo, { new_date: date, note: note }); } }
        async function userAddNote(cNo) { const { value: text } = await Swal.fire({ input: 'textarea', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', placeholder: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...', showCancelButton: true }); if (text) sendUserRequest('add_daily_note', cNo, { note: text }); }
        async function sendUserRequest(actionType, cNo, payload) {
            Swal.fire({ title: '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', didOpen: () => Swal.showLoading() }); try { await fetch(API_URL, { method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action: 'user_action_log', sub_action: actionType, c_no: cNo, user: currentUser.username, ...payload }) }); Swal.fire({ icon: 'success', title: '‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', timer: 1000, showConfirmButton: false });
            const cards = document.querySelectorAll('.cust-id'); cards.forEach(el => { if(el.innerText.includes(cNo)) { const card = el.closest('.cust-card'); card.className = 'cust-card card-pending-approve'; card.querySelector('.status-text').innerHTML = '<i class="fas fa-clock"></i> ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; } });
            } catch (e) { Swal.fire('Error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
        }

        function updateChart(id, type, val1, val2) { const ctx = document.getElementById(id).getContext('2d'); let colors = type === 'daily' ? ['#2ec4b6', '#edf2f4'] : ['#4361ee', '#edf2f4']; if (val2 > 0) colors = type === 'daily' ? ['#2ec4b6', '#e71d36'] : ['#4361ee', '#edf2f4']; if(val2 <= 0 && val1 > 0) colors = type === 'daily' ? ['#2ec4b6', '#2ec4b6'] : ['#4361ee', '#4361ee']; let config = { type: 'doughnut', data: { labels: ['Done', 'Left'], datasets: [{ data: [val1, val2], backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '85%', plugins: { legend: { display: false } } } }; if(type==='daily'){ if(dailyChartInstance) dailyChartInstance.destroy(); dailyChartInstance=new Chart(ctx, config); } else{ if(monthlyChartInstance) monthlyChartInstance.destroy(); monthlyChartInstance=new Chart(ctx, config); } }

        function showSummary(type) {
            let col = type === 'daily' ? (globalSummary.total_collected_today || 0) : (globalSummary.total_collected_month || 0);
            let target = type === 'daily' ? (col + filteredData.reduce((a,b)=>a+b.finalAmount,0)) : (globalSummary.expected_month || globalSummary.total_expected_month || 0);
            let percent = target > 0 ? (col/target*100).toFixed(1) : 0;
            Swal.fire({ title: type === 'daily' ? 'üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' : 'üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', html: `<div style="text-align:center;">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ: <b style="color:green">${col.toLocaleString()}</b> / ‡πÄ‡∏õ‡πâ‡∏≤: <b>${target.toLocaleString()}</b><br>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <b style="color:blue; font-size:1.2em">${percent}%</b></div>`, showCancelButton: true, confirmButtonText: 'üñ®Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', cancelButtonText: '‡∏õ‡∏¥‡∏î' }).then(r => { if(r.isConfirmed) printSummaryReport(type, col, target, percent); });
        }

        // üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        function printSummaryReport(type, col, target, percent) {
            const canvas = document.getElementById(type === 'daily' ? 'dailyChart' : 'monthlyChart');
            const chartImg = canvas.toDataURL("image/png");
            const rawDate = document.getElementById('filterDate').value;
            const dateStr = formatDateToThai(rawDate);
            const fileName = `Report_${rawDate.replace(/-/g, '_')}`;

            let detailsHtml = '';
            let collectedList = [], pendingList = [], postponedList = [];

            if (type === 'daily') {
                pendingList = filteredData; 
                collectedList = currentTrackingData.filter(c => {
                    return (c.status === 'Close' || c.status === 'Paid') && (c.update_date === dateStr || c.last_payment_date === dateStr);
                });
                postponedList = currentTrackingData.filter(c => {
                    const hasDate = c.postpone_date && c.postpone_date !== '-' && c.postpone_date !== '';
                    return hasDate && c.postpone_date !== dateStr && c.status !== 'Close';
                });
            }

            if (type === 'daily') {
                detailsHtml += `<h3 style="color:#27ae60; border-bottom: 2px solid #27ae60; padding-bottom:5px; margin-top:20px;">‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ (Collected)</h3>`;
                if (collectedList.length > 0) {
                    detailsHtml += `<table style="width:100%; border-collapse:collapse; font-size:14px; margin-bottom:20px;"><thead><tr style="background:#e8f8f5; color:#1e8449;"><th style="border:1px solid #ddd; padding:5px;">‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th style="border:1px solid #ddd; padding:5px;">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th style="border:1px solid #ddd; padding:5px;" align="center">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà</th><th style="border:1px solid #ddd; padding:5px;" align="right">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</th></tr></thead><tbody>`;
                    let sumCollected = 0;
                    collectedList.forEach(item => { 
                        let payAmt = item.amount_paid ? parseFloat(item.amount_paid) : parseFloat(item.amount);
                        sumCollected += payAmt;
                        detailsHtml += `<tr><td style="border:1px solid #ddd; padding:5px;">${item.c_no}</td><td style="border:1px solid #ddd; padding:5px;">${item.b_name}</td><td style="border:1px solid #ddd; padding:5px;" align="center">${item.installment_no}</td><td style="border:1px solid #ddd; padding:5px;" align="right">${payAmt.toLocaleString()}</td></tr>`; 
                    });
                    detailsHtml += `<tr style="font-weight:bold; background:#f2f2f2;"><td colspan="3" align="right" style="border:1px solid #ddd; padding:5px;">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</td><td align="right" style="border:1px solid #ddd; padding:5px;">${sumCollected.toLocaleString()}</td></tr></tbody></table>`;
                } else {
                    detailsHtml += `<p style="color:#999; font-style:italic; padding-left:10px;">- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 'Close' ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -</p>`;
                }

                detailsHtml += `<h3 style="color:#c0392b; border-bottom: 2px solid #c0392b; padding-bottom:5px; margin-top:30px;">‚è≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (Pending)</h3>`;
                if (pendingList.length > 0) {
                    detailsHtml += `<table style="width:100%; border-collapse:collapse; font-size:14px; margin-bottom:20px;"><thead><tr style="background:#fdedec; color:#922b21;"><th style="border:1px solid #ddd; padding:5px;">‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th style="border:1px solid #ddd; padding:5px;">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th style="border:1px solid #ddd; padding:5px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th style="border:1px solid #ddd; padding:5px;" align="right">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á</th></tr></thead><tbody>`;
                    let sumPending = 0;
                    pendingList.forEach(item => { 
                        sumPending += item.finalAmount;
                        let statusTxt = item.hasPostpone ? `‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (${item.postpone_date})` : (item.overdue_count > 0 ? `‡∏Ñ‡πâ‡∏≤‡∏á ${item.overdue_count} ‡∏á‡∏ß‡∏î` : '‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î');
                        detailsHtml += `<tr><td style="border:1px solid #ddd; padding:5px;">${item.c_no}</td><td style="border:1px solid #ddd; padding:5px;">${item.b_name}</td><td style="border:1px solid #ddd; padding:5px;">${statusTxt}</td><td style="border:1px solid #ddd; padding:5px;" align="right">${item.finalAmount.toLocaleString()}</td></tr>`; 
                    });
                    detailsHtml += `<tr style="font-weight:bold; background:#f2f2f2;"><td colspan="3" align="right" style="border:1px solid #ddd; padding:5px;">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</td><td align="right" style="border:1px solid #ddd; padding:5px;">${sumPending.toLocaleString()}</td></tr></tbody></table>`;
                } else {
                     detailsHtml += `<p style="color:#999; font-style:italic; padding-left:10px;">- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° -</p>`;
                }

                if (postponedList.length > 0) {
                    detailsHtml += `<h3 style="color:#8e44ad; border-bottom: 2px solid #8e44ad; padding-bottom:5px; margin-top:30px;">üîú ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î (Postponed)</h3>`;
                    detailsHtml += `<table style="width:100%; border-collapse:collapse; font-size:14px; margin-bottom:20px;"><thead><tr style="background:#f4ecf7; color:#8e44ad;"><th style="border:1px solid #ddd; padding:5px;">‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th style="border:1px solid #ddd; padding:5px;">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th style="border:1px solid #ddd; padding:5px;"><i class="fas fa-clock"></i> ‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th style="border:1px solid #ddd; padding:5px;" align="right" style="color:#aaa;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead><tbody>`;
                    postponedList.forEach(item => {
                        detailsHtml += `<tr><td style="border:1px solid #ddd; padding:5px;">${item.c_no}</td><td style="border:1px solid #ddd; padding:5px;">${item.b_name}</td><td style="border:1px solid #ddd; padding:5px; font-weight:bold; color:#8e44ad;">${item.postpone_date}</td><td style="border:1px solid #ddd; padding:5px;" align="right" style="color:#aaa;">${parseFloat(item.amount).toLocaleString()}</td></tr>`; 
                    });
                    detailsHtml += `</tbody></table>`;
                }
            }

            let win = window.open('', '_blank');
            win.document.write(`
                <html>
                <head>
                    <title>${fileName}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Sarabun', sans-serif; padding: 20px; background: #fff; margin:0; } 
                        .container { width: 100%; max-width: 800px; margin: 0 auto; }
                        h3 { margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; }
                        @media print { 
                            .btn-group { display: none; } 
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:15px; margin-bottom:20px;">
                            <div><h1 style="margin:0; font-size:24px; color:#333;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô${type === 'daily' ? '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' : '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}</h1><p style="margin:5px 0 0 0; color:#777;">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr}</p></div>
                            <div style="text-align:right;"><div style="font-size:12px; color:#999;">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}</div></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:20px; border-radius:10px;">
                            <div style="flex:1;">
                                <div style="margin-bottom:10px; font-size:16px;">üíµ ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ: <b style="color:#27ae60; font-size:20px;">${col.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</div>
                                <div style="margin-bottom:10px; font-size:16px;">üìâ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b style="color:#c0392b; font-size:20px;">${(target-col).toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</div>
                                <div style="font-size:16px;">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <b>${target.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</div>
                            </div>
                            <div style="flex:0 0 160px; text-align:center;"><img src="${chartImg}" style="max-width:100%; height:auto;" /><div style="font-size:12px; color:#555; margin-top:5px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${percent}%</div></div>
                        </div>
                        ${detailsHtml}
                        <div class="btn-group" style="text-align:center; margin-top:30px;">
                            <button onclick="window.print()" style="padding:10px 20px; cursor:pointer;">‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        </div>
                    </div>
                </body></html>
            `);
            win.document.close();
        }

        // üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ (Worksheet Fix)
        function printReport() {
            if (!filteredData || filteredData.length === 0) {
                Swal.fire({ icon:'warning', title:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå' });
                return;
            }

            const rawDate = document.getElementById('filterDate').value;
            const dateStrShort = formatDateToThai(rawDate);
            const fileName = `Worksheet_${rawDate.replace(/-/g, '_')}`;

            let rows = filteredData.map((x,i) => `<tr><td align="center">${i+1}</td><td>${x.c_no}</td><td>${x.b_name}</td><td align="center">${x.installment_no}</td><td align="right">${x.finalAmount.toLocaleString()}</td><td align="center">${x.hasPostpone?'‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô':(x.overdue_count>0?'‡∏Ñ‡πâ‡∏≤‡∏á':'‡∏õ‡∏Å‡∏ï‡∏¥')}</td><td></td></tr>`).join('');
            
            let win = window.open('','_blank');
            win.document.write(`
                <html>
                <head>
                    <title>${fileName}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Sarabun', sans-serif; background: #fff; padding: 20px; }
                        h3 { text-align: center; margin: 0 0 20px 0; font-size: 20px; }
                        table { width:100%; border-collapse:collapse; font-size: 14px; } 
                        th,td { border:1px solid #000; padding:6px; vertical-align: middle; } 
                        th { background-color: #eee; font-weight: 600; }
                        tr:nth-child(even) { background:#f9f9f9; }
                        @media print { .btn-group { display: none; } }
                    </style>
                </head>
                <body>
                    <h3>‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ (${dateStrShort})</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="width:40px;">#</th>
                                <th style="width:100px;">‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th style="width:50px;">‡∏á‡∏ß‡∏î</th>
                                <th style="width:80px;">‡∏¢‡∏≠‡∏î</th>
                                <th style="width:60px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    <div class="btn-group" style="text-align:center; margin-top:20px;">
                        <button onclick="window.print()" style="padding:10px 20px;">‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                    </div>
                </body>
                </html>
            `);
            win.document.close();
        }

        function exportToExcel() { if (!filteredData.length) return; let csv = "data:text/csv;charset=utf-8,\uFEFF‡∏•‡∏≥‡∏î‡∏±‡∏ö,‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏ä‡∏∑‡πà‡∏≠,‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏á‡∏ß‡∏î,‡∏¢‡∏≠‡∏î,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n"; filteredData.forEach((i, idx) => csv += `${idx+1},"${i.c_no}","${i.b_name}","${i.b_mobile}",${i.installment_no},${i.finalAmount},"${i.status}"\n`); const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "Report.csv"; link.click(); }
        function openPay(c_no) { window.open(`https://kamkywork.github.io/kamkybill-app/?ref=${c_no}`, '_blank'); }
        function hideContract(c_no) { let h=JSON.parse(localStorage.getItem('hiddenContracts')||'[]'); if(!h.includes(String(c_no))){ h.push(String(c_no)); localStorage.setItem('hiddenContracts',JSON.stringify(h)); loadData(); } }
        function resetHidden() { localStorage.removeItem('hiddenContracts'); loadData(); }
        async function openManageMenu(idx, name, c_no) { const { value: action } = await Swal.fire({ title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤', html: `<b>${name}</b> (${c_no})`, input: 'select', inputOptions: { 'hide': 'üëÅÔ∏è ‡∏ã‡πà‡∏≠‡∏ô', 'cancel_contract': '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤', 'close_account': '‚úÖ ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î' }, showCancelButton: true }); if (action) { if (action === 'hide') hideContract(c_no); else Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?', icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' }).then(r => { if(r.isConfirmed) executeAction({ action: action, c_no: c_no, row_index: idx }); }); } }
        function openPostpone(idx, name, cur) { Swal.fire({ title: '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', html: `<input type="date" id="swal-date" class="swal2-input">`, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', preConfirm: () => document.getElementById('swal-date').value }).then(r => { if(r.isConfirmed && r.value) executeAction({ action: 'postpone', row_index: idx, new_date: r.value }); }); }
        async function executeAction(p) { Swal.fire({ title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() }); try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(p) }); Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false }); loadData(); } catch (e) { Swal.fire('Error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); } }
    </script>
</body>
</html>