<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î - Collection Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
        
        /* Header & Controls */
        .header { background: #2c3e50; color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header h2 { margin: 0; font-size: 18px; }
        
        .date-picker-container { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
        .date-picker-container input { flex: 1; padding: 8px; border-radius: 4px; border: none; min-width: 120px; }
        
        .btn-tool { border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px; color: white; transition: 0.2s; }
        .btn-refresh { background: #f39c12; }
        .btn-report { background: #34495e; }
        .btn-excel { background: #27ae60; }
        .btn-reset-hide { background: #95a5a6; }
        .btn-tool:hover { filter: brightness(1.1); }

        /* Performance Board (New) */
        .perf-container { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .perf-container { grid-template-columns: 1fr; } }

        .perf-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .perf-title { font-size: 14px; color: #7f8c8d; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .perf-percent { font-size: 24px; font-weight: bold; color: #2c3e50; }
        
        /* Progress Bar */
        .progress-bg { height: 8px; background: #ecf0f1; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: #27ae60; width: 0%; transition: width 0.5s ease; }
        
        .perf-detail { display: flex; justify-content: space-between; font-size: 12px; color: #555; }

        /* Summary Stats (Small) */
        .summary-mini { display: flex; gap: 10px; padding: 0 15px; overflow-x: auto; }
        .mini-stat { background: #fff; padding: 8px 12px; border-radius: 6px; font-size: 12px; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex:1; text-align:center;}

        .list-container { padding: 15px; }

        /* Card Design */
        .customer-card {
            background: white; border-radius: 10px; margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden;
            position: relative;
        }

        .card-banner {
            padding: 8px 15px; color: white; font-weight: bold; font-size: 14px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .banner-dark-red { background: linear-gradient(135deg, #b71c1c 0%, #d32f2f 100%); }
        .banner-red { background: #c0392b; }      
        .banner-orange { background: #e67e22; }   
        .banner-yellow { background: #f1c40f; color: #2c3e50; } 
        .banner-purple { background: #8e44ad; }   

        .btn-menu-card {
            background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; margin-left: 10px;
        }

        .card-content { padding: 15px; }
        .cust-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .cust-name { font-weight: bold; font-size: 16px; color: #2c3e50; }
        .cust-id { font-size: 12px; color: #7f8c8d; background: #ecf0f1; padding: 2px 8px; border-radius: 10px; }
        .cust-detail { font-size: 14px; margin-bottom: 5px; color: #555; display: flex; align-items: center; gap: 8px; }
        .amount-highlight { font-size: 24px; font-weight: bold; color: #2c3e50; margin: 15px 0 10px; text-align: right; border-top: 1px dashed #eee; padding-top: 10px; }
        .amount-sub { font-size: 13px; color: #e74c3c; font-weight: normal; display: block; margin-top: -5px;}

        .action-bar { display: flex; gap: 10px; margin-top: 10px; }
        .btn-action { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-pay { background: #27ae60; color: white; }
        .btn-postpone { background: #95a5a6; color: white; }
        .btn-call { background: #3498db; color: white; text-decoration: none; }
        .btn-postpone.active { background: #8e44ad; border: 1px solid #732d91; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>üìä Dashboard ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ</h2>
            <span id="currentTime" style="font-size:12px; opacity:0.8;"></span>
        </div>
        
        <div class="date-picker-container">
            <input type="date" id="filterDate" onchange="loadData()">
            <button class="btn-tool btn-refresh" onclick="loadData()"><i class="fas fa-sync-alt"></i></button>
            <button class="btn-tool btn-report" onclick="printReport()"><i class="fas fa-print"></i></button>
            <button class="btn-tool btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i></button>
            <button class="btn-tool btn-reset-hide" onclick="resetHidden()" title="‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"><i class="fas fa-eye"></i></button>
        </div>
    </div>

    <div class="perf-container">
        <div class="perf-card">
            <div class="perf-title">
                <span><i class="fas fa-calendar-day"></i> ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                <span id="txtTodayTarget" style="font-size:12px;">‡πÄ‡∏õ‡πâ‡∏≤: 0</span>
            </div>
            <div class="perf-percent" id="todayPercent">0%</div>
            <div class="progress-bg">
                <div class="progress-fill" id="progToday"></div>
            </div>
            <div class="perf-detail">
                <span>‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ: <b class="text-green" id="txtTodayCollected">0</b></span>
                <span>‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b class="text-red" id="txtTodayPending">0</b></span>
            </div>
        </div>

        <div class="perf-card">
            <div class="perf-title">
                <span><i class="fas fa-calendar-alt"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
                <span id="txtMonthTarget" style="font-size:12px;">‡πÄ‡∏õ‡πâ‡∏≤: 0</span>
            </div>
            <div class="perf-percent" id="monthPercent">0%</div>
            <div class="progress-bg">
                <div class="progress-fill" id="progMonth" style="background:#3498db;"></div>
            </div>
            <div class="perf-detail">
                <span>‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ: <b style="color:#2980b9;" id="txtMonthCollected">0</b></span>
            </div>
        </div>
    </div>

    <div class="list-container" id="contractList">
        <div style="text-align:center; padding:20px; color:#aaa;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxwv-zrFtI-CFSkAtK5NnLfsAnc5n4gWIkXYICUnKfhUG6twkyE6hvKNlGqTFQ288xW/exec'; 

        let currentTrackingData = [];
        let filteredData = []; 
        document.getElementById('filterDate').valueAsDate = new Date();

        function formatDateToThai(dateString) {
            if(!dateString) return "";
            const p = dateString.split('-');
            return `${p[2]}/${p[1]}/${p[0]}`; 
        }

        async function loadData() {
            const date = document.getElementById('filterDate').value;
            const container = document.getElementById('contractList');
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_tracking', date: date })
                });
                const data = await response.json();
                currentTrackingData = data.contracts || [];
                renderDashboard(data, date);

            } catch (e) {
                console.error(e);
                container.innerHTML = '<div style="color:red; text-align:center;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
        }

        function renderDashboard(data, selectedDate) {
            const container = document.getElementById('contractList');
            container.innerHTML = "";

            // 1. Prepare Hidden Data
            const rawHidden = JSON.parse(localStorage.getItem('hiddenContracts') || '[]');
            const hiddenContracts = rawHidden.map(String); 

            const selectedDateThai = formatDateToThai(selectedDate);
            filteredData = [];
            let displayCount = 0;
            let calculatedPendingToday = 0; // ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏ô)

            // --- Loop Filter & Calculate Pending ---
            if (data.contracts && data.contracts.length > 0) {
                data.contracts.forEach(c => {
                    const currentCNo = String(c.c_no).trim();
                    if (hiddenContracts.includes(currentCNo)) return;

                    const hasPostpone = (c.postpone_date && c.postpone_date !== "-" && c.postpone_date !== "");
                    let shouldShow = false;

                    if (hasPostpone) {
                        if (c.postpone_date === selectedDateThai) shouldShow = true;
                    } else {
                        const isDueToday = (c.due_date === selectedDateThai);
                        const isOverdue = (c.status.includes("‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î") || c.overdue_count > 0);
                        if (isDueToday || isOverdue) shouldShow = true;
                    }

                    if (!shouldShow) return;

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
                    let overdueCount = c.overdue_count || 0;
                    let itemAmount = parseFloat(c.amount);
                    if (overdueCount > 1) itemAmount = itemAmount * overdueCount;

                    // ‡∏ö‡∏ß‡∏Å‡∏¢‡∏≠‡∏î pending
                    calculatedPendingToday += itemAmount;
                    filteredData.push({ ...c, finalAmount: itemAmount, overdueCount: overdueCount, hasPostpone: hasPostpone });
                    displayCount++;
                });
            }

            // 2. Performance Calculation (‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå)
            
            // --- ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ---
            const collectedToday = data.summary.total_collected_today || 0;
            // ‡πÄ‡∏õ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ = ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß + ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö (calculatedPendingToday)
            const targetToday = collectedToday + calculatedPendingToday; 
            const percentToday = targetToday > 0 ? (collectedToday / targetToday) * 100 : 0;

            document.getElementById('txtTodayTarget').innerText = `‡πÄ‡∏õ‡πâ‡∏≤: ${targetToday.toLocaleString()}`;
            document.getElementById('txtTodayCollected').innerText = collectedToday.toLocaleString();
            document.getElementById('txtTodayPending').innerText = calculatedPendingToday.toLocaleString();
            document.getElementById('todayPercent').innerText = `${Math.round(percentToday)}%`;
            document.getElementById('progToday').style.width = `${percentToday}%`;

            // --- ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ---
            const collectedMonth = data.summary.total_collected_month || 0;
            // *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ Backend ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á expected_month ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∞‡πÉ‡∏ä‡πâ 0
            const targetMonth = data.summary.expected_month || data.summary.total_expected_month || 0; 
            const percentMonth = targetMonth > 0 ? (collectedMonth / targetMonth) * 100 : 0;

            document.getElementById('txtMonthTarget').innerText = `‡πÄ‡∏õ‡πâ‡∏≤: ${targetMonth.toLocaleString()}`;
            document.getElementById('txtMonthCollected').innerText = collectedMonth.toLocaleString();
            document.getElementById('monthPercent').innerText = `${Math.round(percentMonth)}%`;
            document.getElementById('progMonth').style.width = `${percentMonth}%`;

            // 3. Render List (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î)
            if (displayCount === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
                return;
            }

            filteredData.forEach(c => {
                let bannerClass = "";
                let statusText = c.status;
                let iconClass = "";
                let postponeClass = "";

                if (c.status.includes("‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î")) {
                    if (c.overdueCount > 1) {
                        bannerClass = "banner-dark-red"; 
                        statusText = `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${c.overdueCount} ‡∏á‡∏ß‡∏î !!`;
                        iconClass = "fa-exclamation-triangle";
                    } else {
                        bannerClass = "banner-red"; 
                        iconClass = "fa-exclamation-circle";
                    }
                } else if (c.status.includes("‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î")) {
                    bannerClass = "banner-yellow";
                    iconClass = "fa-bell";
                } else if (c.status.includes("‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á")) {
                    bannerClass = "banner-orange";
                    statusText = "‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î";
                    iconClass = "fa-clock";
                }
                
                if (c.hasPostpone) {
                    bannerClass = "banner-purple";
                    statusText = `‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏°‡∏≤: ${c.postpone_date}`;
                    iconClass = "fa-calendar-check";
                    postponeClass = "active";
                }

                const html = `
                <div class="customer-card">
                    <div class="card-banner ${bannerClass}">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <i class="fas ${iconClass}"></i> 
                            <span>${statusText}</span>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <span style="font-size:12px; opacity:0.9;">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${c.installment_no}</span>
                            <button class="btn-menu-card" onclick="openManageMenu(${c.row_index}, '${c.b_name}', '${c.c_no}')">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card-content">
                        <div class="cust-row">
                            <div class="cust-name">${c.b_name}</div>
                            <div class="cust-id">${c.c_no}</div>
                        </div>
                        <div class="cust-detail"><i class="fas fa-calendar-day"></i> ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡πà‡∏≤‡∏¢: ${c.due_date}</div>
                        <div class="cust-detail"><i class="fas fa-phone-alt"></i> ${c.b_mobile || '-'}</div>

                        <div class="amount-highlight">
                            ${c.overdueCount > 1 ? `<span class="amount-sub">(‡∏Ñ‡πâ‡∏≤‡∏á ${c.overdueCount} ‡∏á‡∏ß‡∏î)</span>` : ''}
                            ‡∏ø ${c.finalAmount.toLocaleString()}
                        </div>

                        <div class="action-bar">
                            <a href="tel:${c.b_mobile}" class="btn-action btn-call"><i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£</a>
                            <button class="btn-action btn-postpone ${postponeClass}" 
                                onclick="openPostpone(${c.row_index}, '${c.b_name}', '${c.postpone_date || ''}')">
                                <i class="fas fa-clock"></i> ${c.hasPostpone ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏î' : '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô'}
                            </button>
                            <button class="btn-action btn-pay" onclick="openPay('${c.c_no}')"><i class="fas fa-wallet"></i> ‡∏à‡πà‡∏≤‡∏¢</button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        // --- Functions (Hide/Postpone/Report/etc.) ---
        function hideContract(c_no) {
            const contractId = String(c_no).trim();
            let hidden = JSON.parse(localStorage.getItem('hiddenContracts') || '[]');
            hidden = hidden.map(String);

            if (!hidden.includes(contractId)) {
                hidden.push(contractId);
                localStorage.setItem('hiddenContracts', JSON.stringify(hidden));
                Swal.fire({ icon: 'success', title: '‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', timer: 1000, showConfirmButton: false })
                    .then(() => loadData());
            } else { loadData(); }
        }

        function resetHidden() {
            Swal.fire({
                title: '‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?', text: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', icon: 'warning',
                showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', confirmButtonColor: '#3498db'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('hiddenContracts');
                    loadData();
                }
            });
        }

        function openManageMenu(idx, name, c_no) {
            Swal.fire({
                title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤', html: `<b>${name}</b> (${c_no})`, icon: 'info',
                showCancelButton: true, showDenyButton: true,
                confirmButtonText: '<i class="fas fa-eye-slash"></i> ‡∏ã‡πà‡∏≠‡∏ô', confirmButtonColor: '#7f8c8d', 
                denyButtonText: '‡∏•‡∏ö/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', denyButtonColor: '#c0392b', cancelButtonText: '‡∏õ‡∏¥‡∏î'
            }).then((result) => {
                if (result.isConfirmed) hideContract(c_no);
                else if (result.isDenied) openDeleteCancelMenu(idx, name, c_no);
            });
        }

        function openDeleteCancelMenu(idx, name, c_no) {
            Swal.fire({
                title: '‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', html: `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <b>${name}</b>`, icon: 'warning',
                showCancelButton: true, showDenyButton: true,
                confirmButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Cancel)', confirmButtonColor: '#e67e22',
                denyButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Delete)', denyButtonColor: '#c0392b'
            }).then((result) => {
                if (result.isConfirmed) confirmAction(idx, 'cancel_contract', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤?');
                else if (result.isDenied) confirmAction(idx, 'delete_contract', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?');
            });
        }

        function confirmAction(idx, actionType, msg) {
            Swal.fire({ title: msg, icon: 'question', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' })
                .then((r) => { if (r.isConfirmed) executeBackendAction(idx, actionType); });
        }

        async function executeBackendAction(idx, actionType) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: actionType, row_index: idx }) });
                Swal.fire({ icon: 'success', title: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false });
                loadData();
            } catch (error) { Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
        }

        function openPostpone(idx, name, currentDate) {
            Swal.fire({
                title: '‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î', html: `<b>${name}</b><br>‡πÄ‡∏î‡∏¥‡∏°: ${currentDate||'-'}`, icon: 'question',
                showDenyButton: true, showCancelButton: true,
                confirmButtonText: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô', denyButtonText: '‡∏•‡∏ö‡∏ô‡∏±‡∏î', cancelButtonText: '‡∏õ‡∏¥‡∏î',
                confirmButtonColor: '#f39c12', denyButtonColor: '#c0392b'
            }).then((result) => {
                if (result.isConfirmed) showDatePicker(idx, name, ''); 
                else if (result.isDenied) savePostponeData(idx, "");
            });
        }

        function showDatePicker(idx, name, defaultVal) {
            Swal.fire({ title: '‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà', input: 'date', inputValue: defaultVal, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' })
                .then((r) => { if(r.isConfirmed && r.value) savePostponeData(idx, r.value); });
        }

        async function savePostponeData(idx, dateValue) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'postpone', row_index: idx, new_date: dateValue }) });
                Swal.fire({ icon: 'success', title: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false });
                loadData();
            } catch (e) { Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
        }

        function printReport() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!filteredData || filteredData.length === 0) { 
                Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', 'info'); 
                return; 
            }
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
            const selectDate = document.getElementById('filterDate').value;
            const dateParts = selectDate.split('-');
            const thaiDate = `${dateParts[2]}/${dateParts[1]}/${parseInt(dateParts[0])+543}`;
            
            let printWindow = window.open('', '', 'height=800,width=1000');
            
            let tableRows = '';
            let totalAmount = 0;
            
            filteredData.forEach((item, index) => {
                let overdueCount = item.overdue_count || 0;
                let finalAmount = item.finalAmount || (parseFloat(item.amount) * (overdueCount > 1 ? overdueCount : 1));
                
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà) ---
                let displayStatus = item.status; 
                
                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î" ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
                if(item.postpone_date && item.postpone_date !== "-" && item.postpone_date !== "") {
                     // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏á‡∏ß‡∏î <br> (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô)
                     displayStatus = `${item.due_date} <br><span style="font-size:12px; color:#8e44ad; font-weight:bold;">(‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ: ${item.postpone_date})</span>`;
                }
                // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î ‡πÅ‡∏ï‡πà "‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞" ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏á‡∏ß‡∏î
                else if(overdueCount > 1) {
                    displayStatus = `<span style="color:red;font-weight:bold;">‡∏Ñ‡πâ‡∏≤‡∏á ${overdueCount} ‡∏á‡∏ß‡∏î</span>`;
                }
                // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ")
                
                totalAmount += finalAmount;
                
                tableRows += `<tr>
                    <td style="text-align:center;">${index + 1}</td>
                    <td style="text-align:center;">${item.c_no}</td>
                    <td><b>${item.b_name}</b><br><span style="font-size:12px;color:#555;">${item.b_mobile||'-'}</span></td>
                    <td style="text-align:center;">${item.installment_no}</td>
                    <td style="text-align:right; font-weight:bold;">${finalAmount.toLocaleString()}</td>
                    <td style="text-align:center; font-size:14px;">${displayStatus}</td>
                    <td style="border-bottom:1px solid #ddd;"></td>
                </tr>`;
            });
            
            let htmlContent = `
            <html>
            <head>
                <title>‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ</title>
                <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Sarabun', sans-serif; padding: 20px; }
                    h2 { margin-bottom: 5px; }
                    .header-info { text-align:center; margin-bottom: 20px; color: #555; font-size: 14px; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #000; padding: 8px; vertical-align: middle; }
                    th { background: #f2f2f2; height: 35px; }
                </style>
            </head>
            <body>
                <h2 style="text-align:center;">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>
                <div class="header-info">
                    ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <b>${thaiDate}</b> (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleTimeString('th-TH')})
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="15%">‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                            <th width="25%">‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                            <th width="8%">‡∏á‡∏ß‡∏î</th>
                            <th width="15%">‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡πá‡∏ö (‡∏ö‡∏≤‡∏ó)</th>
                            <th width="20%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡πà‡∏≤‡∏¢</th>
                            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" style="text-align:right;font-weight:bold; height:40px;">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                            <td style="text-align:right;font-weight:bold;font-size:16px;">${totalAmount.toLocaleString()}</td>
                            <td colspan="2">‡∏ö‡∏≤‡∏ó</td>
                        </tr>
                    </tfoot>
                </table>
                
                <script>
                    window.onload = function() { window.print(); }
                <\/script>
            </body>
            </html>`;
            
            printWindow.document.write(htmlContent); 
            printWindow.document.close();
        }

        function exportToExcel() {
            if (!filteredData.length) { Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', 'info'); return; }
            let csv = "data:text/csv;charset=utf-8,\uFEFF‡∏•‡∏≥‡∏î‡∏±‡∏ö,‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏ä‡∏∑‡πà‡∏≠,‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏á‡∏ß‡∏î,‡∏¢‡∏≠‡∏î,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n";
            filteredData.forEach((i, idx) => csv += `${idx+1},"${i.c_no}","${i.b_name}","${i.b_mobile}",${i.installment_no},${i.finalAmount},${i.status}\n`);
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "Tracking_Report.csv"; link.click();
        }

        function openPay(c_no) {
            // -------------------------------------------------------
            // üëá 1. ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà URL Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î
            // -------------------------------------------------------
            const billWebAppUrl = "https://script.google.com/macros/s/AKfycbxMppKDUF81jzlUfgyQLBglhTkfI0xuucqPSTFIgV4j62l_Js4ac1_DIJNrV1NPAy0h7g/exec"; 
            
            // 2. ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏ö‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (?ref=...)
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ URL ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
            window.open(`${billWebAppUrl}?ref=${c_no}`, '_blank');
        }
        
        window.onload = loadData;
    </script>
</body>
</html>