<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î - Collection System (V.61 Smart Schedule)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* CSS Original Style V.16/40/58 */
        :root { --primary: #4361ee; --secondary: #3f37c9; --success: #2ec4b6; --warning: #ff9f1c; --danger: #e71d36; --dark: #2b2d42; --light: #f8f9fa; --gray: #8d99ae; --bg: #edf2f4; --card-radius: 16px; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--dark); -webkit-font-smoothing: antialiased; }
        .header { background: #ffffff; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header h2 { margin: 0; font-size: 20px; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 8px; }
        .tools-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; align-items: center; }
        .date-input { border: 1px solid #e0e0e0; background: #f9f9f9; padding: 8px 12px; border-radius: 10px; min-width: 130px; font-family: 'Sarabun'; }
        .btn-icon, .btn-pill { border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-icon { width: 38px; height: 38px; flex-shrink: 0; }
        .btn-pill { padding: 8px 15px; font-size: 13px; font-weight: 600; gap: 5px; border-radius: 20px; white-space: nowrap; }
        .btn-refresh { background: var(--warning); } .btn-print { background: var(--dark); } .btn-excel { background: #20bf6b; } .btn-reset { background: var(--gray); }
        .btn-daily { background: linear-gradient(135deg, #ff9f43, #ee5253); } .btn-monthly { background: linear-gradient(135deg, #54a0ff, #5f27cd); }
        .btn-logout { background: #e74c3c; width: auto; padding: 0 12px; font-size: 12px; height: 38px; }
        .perf-container { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: white; border-radius: var(--card-radius); padding: 20px; box-shadow: var(--shadow); }
        .stat-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 600; color: var(--gray); }
        .chart-box { height: 140px; position: relative; margin-bottom: 15px; }
        .stat-footer { display: flex; justify-content: space-between; background: #f8faff; padding: 10px 15px; border-radius: 12px; }
        .stat-item h4 { margin: 0; font-size: 16px; color: var(--dark); } .stat-item span { font-size: 11px; color: var(--gray); }
        .list-container { padding: 0 20px 80px 20px; max-width: 800px; margin: 0 auto; }
        .cust-card { border-radius: var(--card-radius); margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; background: white; border-left: 5px solid #ddd; transition: 0.2s; }
        .card-postpone { background: #fbf5ff; border-left-color: #9b59b6; } .card-overdue { background: #fff0f0; border-left-color: #e74c3c; } .card-pending-approve { background: #fffdf5; border-left-color: #ffca28; } 
        .cust-header { padding: 15px 15px 5px 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .cust-info h3 { margin: 0 0 4px 0; font-size: 17px; color: var(--dark); }
        .cust-id { font-size: 11px; color: var(--gray); background: rgba(0,0,0,0.03); padding: 3px 8px; border-radius: 6px; display: inline-block; border: 1px solid rgba(0,0,0,0.05); }
        .status-text { font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .text-green { color: #27ae60; } .text-orange { color: #f39c12; cursor: pointer; text-decoration: underline; } .text-purple { color: #8e44ad; } .text-red { color: #c0392b; }
        .btn-kebab { border: none; background: transparent; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--gray); }
        .cust-body { padding: 0 15px 15px 15px; display: flex; justify-content: space-between; align-items: flex-end; }
        .contact-line { font-size: 13px; color: #555; display: flex; align-items: center; gap: 6px; margin-top: 5px; }
        .amount-val { font-size: 22px; font-weight: 800; color: var(--dark); letter-spacing: -0.5px; }
        .cust-actions { padding: 10px 15px; background: rgba(255,255,255,0.5); border-top: 1px solid rgba(0,0,0,0.05); display: grid; gap: 10px; border-bottom-left-radius: var(--card-radius); border-bottom-right-radius: var(--card-radius); }
        .btn-act, .user-checkbox-btn { border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; height: 42px; width: 100%; box-sizing: border-box; background: white; border: 1px solid #e0e0e0; color: #555; }
        .btn-act-call { color: var(--secondary); } .btn-act-contract { background: #34495e; color: white; border:none; } .btn-act-pay { background: var(--dark); color: white; border:none; } .btn-act-postpone { color: #7e22ce; }
        .grid-admin-actions { grid-template-columns: 1fr 1fr 1fr 1fr; } .grid-user-actions { grid-template-columns: 1fr 1fr; }
        @media (max-width: 600px) { .perf-container { grid-template-columns: 1fr; } .grid-admin-actions, .grid-user-actions { grid-template-columns: 1fr 1fr !important; } }
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(43, 45, 66, 0.98); z-index: 9000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px 40px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .user-profile-badge { font-size: 11px; background: #eef3ff; color: var(--primary); padding: 3px 8px; border-radius: 15px; margin-left: 8px; cursor: pointer; display:inline-flex; align-items:center; gap:5px; }
        .loading-state { text-align: center; padding: 40px; color: var(--gray); } .hidden-elm { display: none !important; }
    </style>
</head>
<body>

    <canvas id="tempReportChart" width="400" height="400" style="display:none;"></canvas>

    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--dark); margin-bottom:20px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <input type="text" id="loginUser" class="date-input" style="width:100%; margin-bottom:15px; box-sizing:border-box;" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <input type="password" id="loginPass" class="date-input" style="width:100%; margin-bottom:15px; box-sizing:border-box;" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" onkeyup="if(event.key==='Enter') doLogin()">
            <button class="btn-pill" style="background:var(--primary); width:100%; justify-content:center; padding:12px; font-size:16px;" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            <div id="loginMsg" style="color:red; margin-top:15px; font-size:13px; min-height:20px;"></div>
        </div>
    </div>

    <div class="header">
        <div class="header-top">
            <h2 id="appTitle"><i class="fas fa-chart-pie"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <span id="currentTime" style="font-size:12px; color:var(--gray);"></span>
                <button id="btnLogout" class="btn-icon btn-logout" onclick="doLogout()" style="display:none;"><i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>
        <div class="tools-bar">
            <input type="date" id="filterDate" class="date-input" onchange="loadData()">
            <button class="btn-icon btn-refresh" onclick="loadData()"><i class="fas fa-sync-alt"></i></button>
            <button class="btn-pill btn-daily" onclick="showSummary('daily')"><i class="fas fa-bolt"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô</button>
            <button class="btn-pill btn-monthly" onclick="showSummary('monthly')"><i class="fas fa-calendar-check"></i> ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            <button id="btnPrint" class="btn-icon btn-print" onclick="printReport()"><i class="fas fa-print"></i></button>
            <button id="btnExcel" class="btn-icon btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i></button>
            <button id="btnReset" class="btn-icon btn-reset" onclick="resetHidden()"><i class="fas fa-eye"></i></button>
            <button id="btnAdmin" class="btn-icon" style="background:#2c3e50; display:none;" onclick="manageUsers()" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"><i class="fas fa-users-cog"></i></button>
        </div>
    </div>

    <div class="perf-container">
        <div class="stat-card">
            <div class="stat-header"><span><i class="fas fa-sun" style="color:#ff9f43"></i> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><span id="txtTodayPercent" style="color:var(--success)">0%</span></div>
            <div class="chart-box"><canvas id="dailyChart"></canvas></div>
            <div class="stat-footer"><div class="stat-item"><span>‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</span><h4 id="txtTodayCollected">0</h4></div><div class="stat-item" style="text-align:right"><span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span><h4 id="txtTodayPending">0</h4></div></div>
        </div>
        <div class="stat-card">
            <div class="stat-header"><span><i class="fas fa-calendar" style="color:#54a0ff"></i> ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span><span id="txtMonthPercent" style="color:var(--secondary)">0%</span></div>
            <div class="chart-box"><canvas id="monthlyChart"></canvas></div>
            <div class="stat-footer"><div class="stat-item"><span>‡∏™‡∏∞‡∏™‡∏°</span><h4 id="txtMonthCollected">0</h4></div><div class="stat-item" style="text-align:right"><span>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span><h4 id="txtMonthTarget">0</h4></div></div>
        </div>
    </div>

    <div class="list-container">
        <div class="section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (Follow up)</div>
        <div id="contractList"></div>
    </div>

    <script>
        // üî¥üî¥ ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå API üî¥üî¥
        const API_URL = 'https://script.google.com/macros/s/AKfycbzuhlBBg3Z2tsYBmBsnDex04A9j2gaFXgokVdpJnQ7e0MvCrKwQvWY2miZR8nXFdC8D/exec'; 
        
        let currentUser = null;
        let currentTrackingData = [], filteredData = [], globalSummary = {};
        let dailyChartInstance = null, monthlyChartInstance = null;
        let tempChartInstance = null;

        window.onload = function() {
            const saved = localStorage.getItem('kamky_user');
            if (saved) { currentUser = JSON.parse(saved); initApp(); } 
            else { document.getElementById('filterDate').valueAsDate = new Date(); }
        };

        async function doLogin() {
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            const msg = document.getElementById('loginMsg');
            if(!u || !p) { msg.innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; return; }
            msg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            try {
                const res = await fetch(API_URL, { method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({action:'login', username:u, password:p}) });
                const d = await res.json();
                if(d.status === 'success') {
                    currentUser = d.user;
                    localStorage.setItem('kamky_user', JSON.stringify(currentUser));
                    initApp();
                } else { msg.innerHTML = `‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`; msg.style.color = 'red'; }
            } catch(e) { msg.innerText = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'; msg.style.color = 'red'; }
        }

        function doLogout() { localStorage.removeItem('kamky_user'); location.reload(); }

        function initApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appTitle').innerHTML += ` <span class="user-profile-badge" onclick="userProfile()"><i class="fas fa-user"></i> ${currentUser.name}</span>`;
            document.getElementById('btnLogout').style.display = 'flex';
            if(!document.getElementById('filterDate').value) document.getElementById('filterDate').valueAsDate = new Date();
            const isUser = currentUser.role !== 'admin';
            if (isUser) { ['btnPrint','btnExcel','btnReset'].forEach(id => document.getElementById(id).style.display = 'none'); } 
            else { document.getElementById('btnAdmin').style.display = 'flex'; }
            loadData();
        }

        async function loadData() {
            const date = document.getElementById('filterDate').value;
            const container = document.getElementById('contractList');
            container.innerHTML = '<div class="loading-state">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_tracking', date: date }) });
                const data = await response.json();
                currentTrackingData = data.contracts || []; globalSummary = data.summary || {};
                renderDashboard(data, date);
            } catch (e) { container.innerHTML = '<div class="loading-state" style="color:red">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>'; }
        }

        function renderDashboard(data, selectedDate) {
            const container = document.getElementById('contractList'); container.innerHTML = "";
            const hidden = JSON.parse(localStorage.getItem('hiddenContracts') || '[]').map(String);
            const selectedDateThai = formatDateToThai(selectedDate);
            const isAdmin = currentUser.role === 'admin';
            filteredData = []; let pendingToday = 0;

            if (data.contracts) {
                data.contracts.forEach(c => {
                    if (hidden.includes(String(c.c_no))) return;
                    const hasPost = (c.postpone_date && c.postpone_date !== "-" && c.postpone_date !== "");
                    
                    // üî• Logic ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç V.61: ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ "‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    // - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß -> due_date ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô -> ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ -> ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
                    // - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -> due_date ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -> ‡πÇ‡∏ä‡∏ß‡πå (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
                    if (c.due_date === selectedDateThai || c.overdue_count > 0) {
                        let amt = parseFloat(c.amount) * (c.overdue_count > 1 ? c.overdue_count : 1);
                        pendingToday += amt;
                        
                        // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô
                        // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -> ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ "‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å..."
                        if (c.original_due_date !== selectedDateThai && c.postpone_date === selectedDateThai) {
                            c.worksheetStatus = `‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å ${c.original_due_date}`;
                        } else {
                            c.worksheetStatus = (c.status === 'Pending_Approve' || c.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') ? '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : (c.overdue_count > 0 ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : '‡∏õ‡∏Å‡∏ï‡∏¥');
                        }

                        filteredData.push({ ...c, finalAmount: amt, hasPostpone: hasPost });
                    }
                });
            }

            updateCharts(data.summary, pendingToday);

            if (filteredData.length === 0) { container.innerHTML = '<div class="loading-state">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>'; return; }

            filteredData.forEach(c => {
                let cardClass = "card-normal"; let statusHtml = `<span class="status-text text-green"><i class="fas fa-check-circle"></i> ‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
                let hasPaymentNote = c.last_note && c.last_note.includes('‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞');
                
                if (c.status === 'Pending_Approve' || c.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') { 
                    cardClass = "card-pending-approve"; 
                    if(isAdmin) statusHtml = `<span class="status-text text-orange" onclick="adminApprove('${c.c_no}', ${c.row_index}, '${c.request_date}', '${c.last_note || ''}')">‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏Å‡∏î)</span>`;
                    else statusHtml = `<span class="status-text text-orange">‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>`;
                } 
                else if (c.hasPostpone) { cardClass = "card-postpone"; statusHtml = `<span class="status-text text-purple">‚è∞ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô: ${c.postpone_date}</span>`; } 
                else if (c.overdue_count > 0) { cardClass = "card-overdue"; statusHtml = `<span class="status-text text-red">‚ùó ‡∏Ñ‡πâ‡∏≤‡∏á ${c.overdue_count} ‡∏á‡∏ß‡∏î</span>`; }

                if (hasPaymentNote) statusHtml += `<div style="font-size:11px; color:#4361ee; background:#eef2ff; padding:4px; border-radius:4px; margin-top:4px; border:1px solid #dce6ff;">üí∞ ${c.last_note}</div>`;

                let menuButton = isAdmin ? `<button class="btn-kebab" style="margin-left:5px;" onclick="openManageMenu(${c.row_index},'${c.b_name}','${c.c_no}')">‚ãÆ</button>` : '';
                let actionButtonsHtml = '', gridClass = '';

                if (isAdmin) {
                    gridClass = 'grid-admin-actions';
                    actionButtonsHtml = `
                        <a href="tel:${c.b_mobile}" class="btn-act btn-act-call"><i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£</a>
                        <button class="btn-act btn-act-postpone" onclick="openPostpone(${c.row_index},'${c.b_name}', '${c.postpone_date||''}')"><i class="fas fa-calendar-check"></i> ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
                        <button class="btn-act btn-act-pay" onclick="openPay('${c.c_no}')"><i class="fas fa-wallet"></i> ‡∏à‡πà‡∏≤‡∏¢</button>
                        <button class="btn-act btn-act-contract" onclick="openContractPopup('${c.c_no}')"><i class="fas fa-file-contract"></i> ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</button>
                    `;
                } else {
                    gridClass = 'grid-user-actions';
                    actionButtonsHtml = `
                        <a href="tel:${c.b_mobile}" class="btn-act btn-act-call"><i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£</a>
                        <button class="btn-act btn-act-contract" onclick="openContractPopup('${c.c_no}')"><i class="fas fa-file-contract"></i> ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</button>
                        <button class="user-checkbox-btn" onclick="userReqPay('${c.c_no}')"><i class="far fa-square"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button class="user-checkbox-btn" onclick="userReqPostpone('${c.c_no}')"><i class="far fa-square"></i> ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î</button>
                        <button class="user-checkbox-btn" style="grid-column: 1 / -1;" onclick="userAddNote('${c.c_no}')"><i class="fas fa-pen"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</button>
                    `;
                }

                container.innerHTML += `
                <div class="cust-card ${cardClass}">
                    <div class="cust-header"><div class="cust-info"><h3>${c.b_name}</h3><span class="cust-id">#${c.c_no}</span></div><div class="status-badge">${statusHtml}</div>${menuButton}</div>
                    <div class="cust-body"><div><div class="contact-line"><i class="fas fa-phone"></i> ${c.b_mobile}</div><div class="contact-line">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${c.installment_no}</div></div><div style="text-align:right"><span style="font-size:10px; color:#777;">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span><div class="amount-val">‡∏ø${c.finalAmount.toLocaleString()}</div></div></div>
                    <div class="cust-actions ${gridClass}">${actionButtonsHtml}</div>
                </div>`;
            });
        }

        async function userReqPay(cNo) {
            const { value: f } = await Swal.fire({
                title: '‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
                html: `<div style="text-align:left; font-size:14px; color:#555; margin-bottom:5px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</div><input id="amt" type="number" class="swal2-input" style="width:100%; box-sizing:border-box;"><div style="text-align:left; font-size:14px; color:#555; margin:10px 0 5px;">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</div><select id="mth" class="swal2-input" style="width:100%; box-sizing:border-box;"><option>‡πÇ‡∏≠‡∏ô</option><option>‡πÇ‡∏≠‡∏ô‡∏£‡πâ‡∏≤‡∏ô</option><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option></select><div style="text-align:left; font-size:14px; color:#555; margin:10px 0 5px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><input id="rem" class="swal2-input" style="width:100%; box-sizing:border-box;">`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                preConfirm: () => { const amt = document.getElementById('amt').value; const mth = document.getElementById('mth').value; const rem = document.getElementById('rem').value; if (!amt) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î'); return false; } return { amt, mth, rem }; }
            });
            if (f) sendUserRequest('request_pay', cNo, { note: `‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞: ${f.amt} (${f.mth}) ${f.rem}` });
        }

        async function userReqPostpone(cNo) { Swal.fire({title:'‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î', input:'date'}).then(r=>{if(r.value) sendUserRequest('request_postpone', cNo, {new_date:r.value});}); }
        async function userAddNote(cNo) { Swal.fire({input:'text', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}).then(r=>{if(r.value) sendUserRequest('add_daily_note', cNo, {note:r.value});}); }
        async function sendUserRequest(act, cNo, pl) { Swal.showLoading(); await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'user_action_log', sub_action:act, c_no:cNo, user:currentUser.username, ...pl})}); Swal.fire('‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'); loadData(); }

        async function adminApprove(cNo, rowIndex, reqDate, details) {
            Swal.fire({
                title: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', html: `<p>‡∏™‡∏±‡∏ç‡∏ç‡∏≤ #${cNo}</p><h2 style="color:#4361ee;">${reqDate}</h2><p>${details}</p>`,
                icon: 'question', showCancelButton: true, confirmButtonText: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.showLoading();
                    if (reqDate && reqDate !== '-') await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'postpone', row_index: rowIndex, new_date: reqDate }) });
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'approve_contract', row_index: rowIndex }) });
                    Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '', 'success').then(() => loadData());
                }
            });
        }

        function openPostpone(idx, name, currentVal) {
            Swal.fire({
                title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
                html: `<div style="margin-bottom:10px;">‡πÄ‡∏î‡∏¥‡∏°: <b>${currentVal || '-'}</b></div><input type="date" id="swal-date" class="swal2-input">`,
                showDenyButton: true, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', denyButtonText: '‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', cancelButtonText: '‡∏õ‡∏¥‡∏î'
            }).then(r => {
                if (r.isConfirmed) executeAction({ action: 'postpone', row_index: idx, new_date: document.getElementById('swal-date').value });
                else if (r.isDenied) executeAction({ action: 'postpone', row_index: idx, new_date: '' });
            });
        }

        function showSummary(type) { Swal.fire({ title: `‡∏™‡∏£‡∏∏‡∏õ${type==='daily'?'‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô':'‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}`, showCancelButton:true, confirmButtonText:'‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô' }).then(r=>{if(r.isConfirmed) printSummaryReport(type)}); }

        function printSummaryReport(type) {
            const rawDate = document.getElementById('filterDate').value;
            const dateStr = formatDateToThai(rawDate);
            const now = new Date();
            const fileName = `Report_${now.getFullYear()}${(now.getMonth()+1+'').padStart(2,'0')}${now.getDate()}_${now.getHours()}${now.getMinutes()}`;
            
            let detailsHtml = '';
            let collectedList = [], pendingList = [], appointList = [], movedList = [];
            
            if (type === 'daily') {
                collectedList = currentTrackingData.filter(c => (c.status === 'Close' || c.status === 'Paid') && (c.update_date === dateStr || c.last_payment_date === dateStr));
                
                // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡∏µ" ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ô filteredData ‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏£‡∏≤‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≠‡∏Å)
                // ‡∏ï‡πâ‡∏≠‡∏á loop ‡∏à‡∏≤‡∏Å currentTrackingData ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏µ‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô
                currentTrackingData.forEach(item => {
                    // 1. ‡∏ô‡∏±‡∏î‡∏°‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -> Appoint
                    if (item.postpone_date === dateStr) {
                        appointList.push(item);
                    } 
                    // 2. ‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô -> Moved
                    else if (item.original_due_date === dateStr && item.postpone_date && item.postpone_date !== '-' && item.postpone_date !== dateStr) {
                        movedList.push(item);
                    } 
                    // 3. ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
                    else if (item.due_date === dateStr || item.overdue_count > 0) {
                        if (item.status !== 'Close' && item.status !== 'Paid') pendingList.push(item);
                    }
                });
            }

            let totalCol = collectedList.reduce((sum, i) => sum + (i.amount_paid ? parseFloat(i.amount_paid) : parseFloat(i.amount)), 0);
            let totalRem = 0;
            pendingList.forEach(i => totalRem += i.amount); // ‡πÉ‡∏ä‡πâ i.amount ‡πÅ‡∏ó‡∏ô finalAmount ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å raw data
            appointList.forEach(i => totalRem += i.amount);

            // Chart
            const ctx = document.getElementById('tempReportChart').getContext('2d');
            if(tempChartInstance) tempChartInstance.destroy();
            tempChartInstance = new Chart(ctx, { type: 'pie', data: { labels: ['‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ', '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'], datasets: [{ data: [totalCol, totalRem], backgroundColor: ['#2ecc71', '#e74c3c'], borderWidth: 1 }] }, options: { animation: false, responsive: false } });

            setTimeout(() => {
                const pieChartImg = document.getElementById('tempReportChart').toDataURL("image/png");

                if (type === 'daily') {
                    // 1. Collected
                    detailsHtml += `<h3 style="color:#27ae60; border-bottom:2px solid #27ae60; padding-bottom:5px;">‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ (Collected)</h3>`;
                    detailsHtml += `<table style="width:100%; border-collapse:collapse; font-size:14px; margin-bottom:20px;"><thead><tr style="background:#e8f8f5; color:#1e8449;"><th style="border:1px solid #ddd; padding:5px;">‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th style="border:1px solid #ddd;">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th style="border:1px solid #ddd;" align="right">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</th><th style="border:1px solid #ddd;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody>`;
                    if(collectedList.length){ collectedList.forEach(i => { let p = i.amount_paid?parseFloat(i.amount_paid):parseFloat(i.amount); detailsHtml += `<tr><td style="border:1px solid #ddd; padding:5px;">${i.c_no}</td><td style="border:1px solid #ddd; padding:5px;">${i.b_name}</td><td style="border:1px solid #ddd; padding:5px;" align="right">${p.toLocaleString()}</td><td style="border:1px solid #ddd; padding:5px;">${i.last_note||'-'}</td></tr>`; }); detailsHtml += `<tr style="font-weight:bold; background:#f2f2f2;"><td colspan="2" align="right" style="border:1px solid #ddd; padding:5px;">‡∏£‡∏ß‡∏°</td><td align="right" style="border:1px solid #ddd; padding:5px;">${totalCol.toLocaleString()}</td><td></td></tr>`; } else { detailsHtml += `<tr><td colspan="4" style="text-align:center;border:1px solid #ddd;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ -</td></tr>`; }
                    detailsHtml += `</tbody></table>`;

                    // 2. Pending
                    let sumPending = 0;
                    detailsHtml += `<h3 style="color:#c0392b; border-bottom:2px solid #c0392b; padding-bottom:5px;">‚è≥ ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Pending)</h3>`;
                    detailsHtml += `<table style="width:100%; border-collapse:collapse; font-size:14px; margin-bottom:20px;"><thead><tr style="background:#fdedec; color:#922b21;"><th style="border:1px solid #ddd; padding:5px;">‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th style="border:1px solid #ddd;">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th style="border:1px solid #ddd;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th style="border:1px solid #ddd;" align="right">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á</th><th style="border:1px solid #ddd;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody>`;
                    if(pendingList.length){ pendingList.forEach(i => { let amt = i.amount; sumPending += amt; detailsHtml += `<tr><td style="border:1px solid #ddd; padding:5px;">${i.c_no}</td><td style="border:1px solid #ddd; padding:5px;">${i.b_name}</td><td style="border:1px solid #ddd; padding:5px;">${i.status||'‡∏õ‡∏Å‡∏ï‡∏¥'}</td><td style="border:1px solid #ddd; padding:5px;" align="right">${amt.toLocaleString()}</td><td style="border:1px solid #ddd; padding:5px;">${i.last_note||'-'}</td></tr>`; }); detailsHtml += `<tr style="font-weight:bold; background:#f2f2f2;"><td colspan="3" align="right" style="border:1px solid #ddd; padding:5px;">‡∏£‡∏ß‡∏°</td><td align="right" style="border:1px solid #ddd; padding:5px;">${sumPending.toLocaleString()}</td><td></td></tr>`; } else { detailsHtml += `<tr><td colspan="5" style="text-align:center;border:1px solid #ddd;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ -</td></tr>`; }
                    detailsHtml += `</tbody></table>`;

                    // 3. Appointment
                    let sumAppoint = 0;
                    detailsHtml += `<h3 style="color:#8e44ad; border-bottom:2px solid #8e44ad; padding-bottom:5px;">üìÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏°‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Appointment)</h3>`;
                    detailsHtml += `<table style="width:100%; border-collapse:collapse; font-size:14px; margin-bottom:20px;"><thead><tr style="background:#f4ecf7; color:#8e44ad;"><th style="border:1px solid #ddd; padding:5px;">‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th style="border:1px solid #ddd;">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th style="border:1px solid #ddd;" align="right">‡∏¢‡∏≠‡∏î</th><th style="border:1px solid #ddd;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody>`;
                    if(appointList.length){ appointList.forEach(i => { let amt = i.amount; sumAppoint += amt; detailsHtml += `<tr><td style="border:1px solid #ddd; padding:5px;">${i.c_no}</td><td style="border:1px solid #ddd; padding:5px;">${i.b_name}</td><td style="border:1px solid #ddd; padding:5px;" align="right">${amt.toLocaleString()}</td><td style="border:1px solid #ddd; padding:5px;">${i.last_note||'-'}</td></tr>`; }); detailsHtml += `<tr style="font-weight:bold; background:#f2f2f2;"><td colspan="2" align="right" style="border:1px solid #ddd;">‡∏£‡∏ß‡∏°</td><td align="right" style="border:1px solid #ddd;">${sumAppoint.toLocaleString()}</td><td></td></tr>`; } else { detailsHtml += `<tr><td colspan="4" style="text-align:center;border:1px solid #ddd;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ -</td></tr>`; }
                    detailsHtml += `</tbody></table>`;

                    // 4. Moved Away
                    detailsHtml += `<h3 style="color:#8e44ad; border-bottom:2px solid #8e44ad; padding-bottom:5px;">üîú ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ (Deferred) <span style="font-size:12px; font-weight:normal;">*‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î</span></h3>`;
                    detailsHtml += `<table style="width:100%; border-collapse:collapse; font-size:14px;"><thead><tr style="background:#eee;"><th style="border:1px solid #ddd;">‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th style="border:1px solid #ddd;">‡∏ä‡∏∑‡πà‡∏≠</th><th style="border:1px solid #ddd;">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ</th><th style="border:1px solid #ddd;" align="right">‡∏¢‡∏≠‡∏î</th><th style="border:1px solid #ddd;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody>`;
                    if(movedList.length){ movedList.forEach(i => { detailsHtml += `<tr><td style="border:1px solid #ddd;">${i.c_no}</td><td style="border:1px solid #ddd;">${i.b_name}</td><td style="border:1px solid #ddd; font-weight:bold;">${i.postpone_date}</td><td style="border:1px solid #ddd;" align="right">${parseFloat(i.amount).toLocaleString()}</td><td style="border:1px solid #ddd;">${i.last_note||'-'}</td></tr>`; }); } else { detailsHtml += `<tr><td colspan="5" style="text-align:center;border:1px solid #ddd;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ -</td></tr>`; }
                    detailsHtml += `</tbody></table>`;
                }

                let totalTarget = totalCol + totalRem;
                let percent = totalTarget > 0 ? ((totalCol / totalTarget) * 100).toFixed(1) : 0;

                let win = window.open('','_blank');
                win.document.write(`<html><head><title>${fileName}</title><link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script><style>body{font-family:'Sarabun';padding:20px;text-align:center;}</style></head><body>
                <div id="captureArea" style="background:white; padding:20px; max-width:800px; margin:0 auto; text-align:left;">
                    <h2 style="text-align:center;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô (${dateStr})</h2>
                    <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:20px;">
                        <div>
                            <div style="font-size:18px;">üíµ ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ: <b style="color:#27ae60;">${totalCol.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</div>
                            <div style="font-size:18px;">üìâ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b style="color:#c0392b;">${totalRem.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</div>
                            <div style="font-size:18px;">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <b>${totalTarget.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</div>
                            <div style="font-size:20px; margin-top:10px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <b style="color:blue;">${percent}%</b></div>
                        </div>
                        <div><img src="${pieChartImg}" style="max-width:200px;"></div>
                    </div>
                    ${detailsHtml}
                </div>
                <div style="text-align:center; margin-top:20px; gap:10px; display:flex; justify-content:center;">
                    <button onclick="window.print()" style="padding:10px 20px;">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                    <button onclick="saveImg()" style="padding:10px 20px; background:#27ae60; color:white; border:none;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</button>
                </div>
                <script>function saveImg(){ html2canvas(document.getElementById('captureArea')).then(c=>{ let l=document.createElement('a'); l.download='${fileName}.jpg'; l.href=c.toDataURL(); l.click(); }); }<\/script>
                </body></html>`);
                win.document.close();
            }, 500);
        }

        // Worksheet
        function printReport() {
            if (!filteredData.length) return;
            const rawDate = document.getElementById('filterDate').value;
            const dateStr = formatDateToThai(rawDate);
            const now = new Date();
            const fileName = `Worksheet_${now.getFullYear()}${(now.getMonth()+1+'').padStart(2,'0')}${now.getDate()}_${now.getHours()}${now.getMinutes()}`;
            
            let rows = filteredData.map((x,i) => `<tr><td align="center">${i+1}</td><td>${x.c_no}</td><td>${x.b_name}</td><td align="center">${x.installment_no}</td><td align="right">${x.finalAmount.toLocaleString()}</td><td align="center">${x.worksheetStatus || x.status}</td><td>${x.last_note||''}</td></tr>`).join('');
            
            let win = window.open('','_blank');
            win.document.write(`<html><head><title>Worksheet</title><link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script><style>body{font-family:'Sarabun';padding:20px;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #000;padding:6px;} th{background:#eee;} @media print{.btn-group{display:none;}}</style></head><body>
            <div id="captureArea" style="background:white; padding:20px; max-width:800px; margin:0 auto;">
                <h3 style="text-align:center;">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ (${dateStr})</h3>
                <table><thead><tr><th width="40">#</th><th width="100">‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th><th width="50">‡∏á‡∏ß‡∏î</th><th width="80">‡∏¢‡∏≠‡∏î</th><th width="60">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody>${rows}</tbody></table>
            </div>
            <div class="btn-group" style="text-align:center; margin-top:20px; gap:10px; display:flex; justify-content:center;">
                <button onclick="window.print()" style="padding:10px 20px;">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                <button onclick="saveImg()" style="padding:10px 20px; background:#27ae60; color:white; border:none;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</button>
            </div>
            <script>function saveImg(){ html2canvas(document.getElementById('captureArea')).then(c=>{ let l=document.createElement('a'); l.download='${fileName}.jpg'; l.href=c.toDataURL(); l.click(); }); }<\/script>
            </body></html>`);
            win.document.close();
        }

        // Utils
        function formatDateToThai(dateString) { if(!dateString) return ""; const p = dateString.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
        function updateChart(id, type, val1, val2) { const ctx = document.getElementById(id).getContext('2d'); let colors = type === 'daily' ? ['#2ec4b6', '#edf2f4'] : ['#4361ee', '#edf2f4']; if (val2 > 0) colors = type === 'daily' ? ['#2ec4b6', '#e71d36'] : ['#4361ee', '#edf2f4']; let config = { type: 'doughnut', data: { datasets: [{ data: [val1, val2], backgroundColor: colors, borderWidth: 0 }] }, options: { cutout: '85%', plugins: { legend: { display: false } } } }; if(type==='daily'){ if(dailyChartInstance) dailyChartInstance.destroy(); dailyChartInstance=new Chart(ctx, config); } else{ if(monthlyChartInstance) monthlyChartInstance.destroy(); monthlyChartInstance=new Chart(ctx, config); } }
        function updateCharts(summary, pending) { const colToday=summary.total_collected_today||0; document.getElementById('txtTodayCollected').innerText=colToday.toLocaleString(); document.getElementById('txtTodayPending').innerText=pending.toLocaleString(); document.getElementById('txtTodayPercent').innerText=(colToday+pending)>0?Math.round((colToday/(colToday+pending))*100)+'%':'0%'; updateChart('dailyChart',colToday,pending); const colMonth=summary.total_collected_month||0; const tarMonth=summary.expected_month||0; document.getElementById('txtMonthCollected').innerText=colMonth.toLocaleString(); document.getElementById('txtMonthTarget').innerText=tarMonth.toLocaleString(); document.getElementById('txtMonthPercent').innerText=tarMonth>0?Math.round((colMonth/tarMonth)*100)+'%':'0%'; updateChart('monthlyChart',colMonth,Math.max(0,tarMonth-colMonth)); }
        function exportToExcel() { if (!filteredData.length) return; let csv = "data:text/csv;charset=utf-8,\uFEFF‡∏•‡∏≥‡∏î‡∏±‡∏ö,‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏ä‡∏∑‡πà‡∏≠,‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏á‡∏ß‡∏î,‡∏¢‡∏≠‡∏î,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n"; filteredData.forEach((i, idx) => csv += `${idx+1},"${i.c_no}","${i.b_name}","${i.b_mobile}",${i.installment_no},${i.finalAmount},"${i.status}"\n`); const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "Report.csv"; link.click(); }
        function openPay(c_no) { window.open(`https://kamkywork.github.io/kamkybill-app/?ref=${c_no}`, '_blank'); }
        function hideContract(c_no) { let h=JSON.parse(localStorage.getItem('hiddenContracts')||'[]'); if(!h.includes(String(c_no))){ h.push(String(c_no)); localStorage.setItem('hiddenContracts',JSON.stringify(h)); loadData(); } }
        function resetHidden() { localStorage.removeItem('hiddenContracts'); loadData(); }
        async function openManageMenu(idx, name, c_no) { const { value: action } = await Swal.fire({ title: name, input: 'select', inputOptions: { 'hide': 'üëÅÔ∏è ‡∏ã‡πà‡∏≠‡∏ô', 'cancel_contract': '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤', 'close_account': '‚úÖ ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î' }, showCancelButton: true }); if(action){ if(action==='hide') hideContract(c_no); else Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?',showCancelButton:true}).then(r=>{if(r.isConfirmed) executeAction({action,c_no,row_index:idx})}); } }
        async function executeAction(p) { Swal.fire({ title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() }); try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(p) }); Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false }); loadData(); } catch (e) { Swal.fire('Error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); } }
        async function openContractPopup(cNo) { Swal.showLoading(); const res = await fetch(API_URL, { method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action: 'get_contract_image', c_no: cNo }) }); const d = await res.json(); if(d.status==='success') Swal.fire({ imageUrl: d.url, width: '95%', showCloseButton: true, confirmButtonText: '‡∏õ‡∏¥‡∏î' }); else Swal.fire({ icon: 'warning', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå' }); }
        function userProfile() { Swal.fire({ title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', html: `<b>${currentUser.name}</b><br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${currentUser.role}`, showDenyButton: true, confirmButtonText: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', denyButtonText: '‡∏õ‡∏¥‡∏î' }).then(r => { if(r.isConfirmed) changePass(); }); }
        async function changePass() { const { value: p } = await Swal.fire({ title: '‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà', input: 'password' }); if(p) { await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'change_password', username:currentUser.username, new_pass:p}) }); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } }
    </script>
</body>
</html>