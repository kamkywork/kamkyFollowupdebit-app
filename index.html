<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î - Collection System (V.Final)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* CSS Style V.70 */
        :root { --primary: #4361ee; --secondary: #3f37c9; --success: #2ec4b6; --warning: #ff9f1c; --danger: #e71d36; --dark: #2b2d42; --light: #f8f9fa; --gray: #8d99ae; --bg: #edf2f4; --card-radius: 16px; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--dark); -webkit-font-smoothing: antialiased; }
        .header { background: #ffffff; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header h2 { margin: 0; font-size: 20px; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 8px; }
        .tools-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; align-items: center; flex-wrap: wrap; }
        .date-input, .search-input { border: 1px solid #e0e0e0; background: #f9f9f9; padding: 8px 12px; border-radius: 10px; font-family: 'Sarabun'; }
        .date-input { min-width: 130px; }
        .search-box-group { display: flex; align-items: center; background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 10px; padding-right: 5px; }
        .search-input { width: 120px; border: none; background: transparent; transition: width 0.3s; }
        .search-input:focus { width: 160px; outline: none; }
        .btn-search-icon { color: var(--primary); cursor: pointer; padding: 5px; }
        .btn-icon, .btn-pill { border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-icon { width: 38px; height: 38px; flex-shrink: 0; }
        .btn-pill { padding: 8px 15px; font-size: 13px; font-weight: 600; gap: 5px; border-radius: 20px; white-space: nowrap; }
        .btn-refresh { background: var(--warning); } .btn-print { background: var(--dark); } .btn-excel { background: #20bf6b; } .btn-reset { background: var(--gray); }
        .btn-daily { background: linear-gradient(135deg, #ff9f43, #ee5253); } .btn-monthly { background: linear-gradient(135deg, #54a0ff, #5f27cd); }
        .btn-logout { background: #e74c3c; width: auto; padding: 0 12px; font-size: 12px; height: 38px; }
        .perf-container { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: white; border-radius: var(--card-radius); padding: 20px; box-shadow: var(--shadow); }
        .stat-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 600; color: var(--gray); }
        .chart-box { height: 140px; position: relative; margin-bottom: 15px; }
        .stat-footer { display: flex; justify-content: space-between; background: #f8faff; padding: 10px 15px; border-radius: 12px; }
        .stat-item h4 { margin: 0; font-size: 16px; color: var(--dark); } .stat-item span { font-size: 11px; color: var(--gray); }
        .list-container { padding: 0 20px 80px 20px; max-width: 800px; margin: 0 auto; }
        .accordion-group { margin-bottom: 20px; }
        .accordion-header { background: white; padding: 12px 15px; border-radius: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--dark); box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; transition: 0.2s; }
        .accordion-header:hover { background: #f1f4f9; }
        .accordion-content { display: none; animation: slideDown 0.3s ease-out; }
        .accordion-content.active { display: block; }
        .badge-count { background: var(--gray); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: auto; margin-right: 10px; }
        .cust-card { border-radius: var(--card-radius); margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; background: white; border-left: 5px solid #ddd; transition: 0.2s; }
        .card-postpone { background: #fbf5ff; border-left-color: #9b59b6; } .card-overdue { background: #fff0f0; border-left-color: #e74c3c; } .card-pending-approve { background: #fffdf5; border-left-color: #ffca28; } .card-search-result { border-left-color: #4361ee; background: #f0f4ff; }
        .cust-header { padding: 15px 15px 5px 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .cust-info h3 { margin: 0 0 4px 0; font-size: 17px; color: var(--dark); }
        .cust-id { font-size: 11px; color: var(--gray); background: rgba(0,0,0,0.03); padding: 3px 8px; border-radius: 6px; display: inline-block; border: 1px solid rgba(0,0,0,0.05); }
        .status-text { font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .text-green { color: #27ae60; } .text-orange { color: #f39c12; cursor: pointer; text-decoration: underline; } .text-purple { color: #8e44ad; } .text-red { color: #c0392b; }
        .btn-kebab { border: none; background: transparent; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--gray); }
        .cust-body { padding: 0 15px 15px 15px; display: flex; justify-content: space-between; align-items: flex-end; }
        .contact-line { font-size: 13px; color: #555; display: flex; align-items: center; gap: 6px; margin-top: 5px; }
        .amount-val { font-size: 22px; font-weight: 800; color: var(--dark); letter-spacing: -0.5px; }
        .cust-actions { padding: 10px 15px; background: rgba(255,255,255,0.5); border-top: 1px solid rgba(0,0,0,0.05); display: grid; gap: 10px; border-bottom-left-radius: var(--card-radius); border-bottom-right-radius: var(--card-radius); }
        .btn-act, .user-checkbox-btn { border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; height: 42px; width: 100%; box-sizing: border-box; background: white; border: 1px solid #e0e0e0; color: #555; }
        .btn-act-call { color: var(--secondary); } .btn-act-contract { background: #34495e; color: white; border:none; } .btn-act-info { background: #1abc9c; color: white; border:none; } .btn-act-pay { background: var(--dark); color: white; border:none; } .btn-act-postpone { color: #7e22ce; } .btn-disabled { background: #f1f1f1 !important; color: #ccc !important; border: 1px solid #eee !important; cursor: not-allowed !important; }
        .grid-admin-actions { grid-template-columns: 1fr 1fr 1fr 1fr; } .grid-user-actions { grid-template-columns: 1fr 1fr 1fr 1fr; } 
        @media (max-width: 600px) { .perf-container { grid-template-columns: 1fr; } .grid-admin-actions { grid-template-columns: 1fr 1fr; } .grid-user-actions { grid-template-columns: 1fr 1fr; } }
        .login-overlay { position: fixed; top: 0; left: 100%; width: 100%; height: 100%; background: rgba(43, 45, 66, 0.98); z-index: 9000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px 40px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .user-profile-badge { font-size: 11px; background: #eef3ff; color: var(--primary); padding: 3px 8px; border-radius: 15px; margin-left: 8px; cursor: pointer; display:inline-flex; align-items:center; gap:5px; }
        .loading-state { text-align: center; padding: 40px; color: var(--gray); } .hidden-elm { display: none !important; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
        /* Style for file input in SweetAlert */
        .swal2-file-input { font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="loginOverlay" class="login-overlay" style="left:0;">
        <div class="login-box">
            <h2 style="color:var(--dark); margin-bottom:20px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <input type="text" id="loginUser" class="date-input" style="width:100%; margin-bottom:15px; box-sizing:border-box;" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <input type="password" id="loginPass" class="date-input" style="width:100%; margin-bottom:15px; box-sizing:border-box;" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" onkeyup="if(event.key==='Enter') doLogin()">
            <button class="btn-pill" style="background:var(--primary); width:100%; justify-content:center; padding:12px; font-size:16px;" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            <div id="loginMsg" style="color:red; margin-top:15px; font-size:13px; min-height:20px;"></div>
        </div>
    </div>

    <div class="header">
        <div class="header-top">
            <h2 id="appTitle"><i class="fas fa-chart-pie"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <span id="currentTime" style="font-size:12px; color:var(--gray);"></span>
                <button id="btnLogout" class="btn-icon btn-logout" onclick="doLogout()" style="display:none;"><i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>
        <div class="tools-bar">
            <div class="search-box-group">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤..." onkeyup="if(event.key==='Enter') doGlobalSearch()">
                <i class="fas fa-search btn-search-icon" onclick="doGlobalSearch()"></i>
            </div>
            
            <input type="date" id="filterDate" class="date-input" onchange="loadData()">
            <button class="btn-icon btn-refresh" onclick="loadData()"><i class="fas fa-sync-alt"></i></button>
            <button class="btn-pill btn-daily" onclick="showSummary('daily')"><i class="fas fa-bolt"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô</button>
            <button class="btn-pill btn-monthly" onclick="showSummary('monthly')"><i class="fas fa-calendar-check"></i> ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            
            <button id="btnPrint" class="btn-icon btn-print" onclick="printReport()"><i class="fas fa-print"></i></button>
            <button id="btnExcel" class="btn-icon btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i></button>
            <button id="btnReset" class="btn-icon btn-reset" onclick="resetHidden()"><i class="fas fa-eye"></i></button>
            <button id="btnAdmin" class="btn-icon" style="background:#2c3e50; display:none;" onclick="manageUsers()" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"><i class="fas fa-users-cog"></i></button>
        </div>
    </div>

    <div class="perf-container" id="statContainer">
        <div class="stat-card">
            <div class="stat-header"><span><i class="fas fa-sun" style="color:#ff9f43"></i> ‡πÄ‡∏õ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today)</span><span id="txtTodayPercent" style="color:var(--success)">0%</span></div>
            <div class="chart-box"><canvas id="dailyChart"></canvas></div>
            <div class="stat-footer">
                <div class="stat-item"><span>‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</span><h4 id="txtTodayCollected">0</h4></div>
                <div class="stat-item" style="text-align:right"><span>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö</span><h4 id="txtTodayPending">0</h4></div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-header"><span><i class="fas fa-calendar" style="color:#54a0ff"></i> ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (Month)</span><span id="txtMonthPercent" style="color:var(--secondary)">0%</span></div>
            <div class="chart-box"><canvas id="monthlyChart"></canvas></div>
            <div class="stat-footer">
                <div class="stat-item"><span>‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</span><h4 id="txtMonthCollected">0</h4></div>
                <div class="stat-item" style="text-align:right"><span>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span><h4 id="txtMonthTarget">0</h4></div>
            </div>
        </div>
    </div>

    <div class="list-container">
        <div id="searchResultTitle" style="display:none; margin-bottom:10px; font-weight:bold; color:var(--primary);">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: <span id="txtSearchKeyword"></span> <button onclick="clearSearch()" style="background:#ddd; border:none; padding:3px 8px; border-radius:5px; cursor:pointer; font-size:12px;">‡∏•‡πâ‡∏≤‡∏á</button></div>
        <div id="contractList"></div>
    </div>

    <script>
        // üî¥üî¥ ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå API (Web App URL) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà üî¥üî¥
        const API_URL = 'https://script.google.com/macros/s/AKfycbzrP1CQN-wrGXNb-3Tf2K6lKxnqhGjd2VVmn4qrGgmApKFEC-cyY6sfosCqjKsKk5PK/exec'; 
        
        let currentUser = null;
        let currentTrackingData = [], filteredData = [], globalSummary = {};
        let dailyChartInstance = null, monthlyChartInstance = null;
        let isSearchMode = false;

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- Helper: ‡πÅ‡∏õ‡∏•‡∏á URL ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î + ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö) ---
        function linkify(text) {
            if (!text) return '';
            const urlRegex = /(https?:\/\/[^\]\s]+)/g;
            return text.replace(urlRegex, function(url) {
                let downloadUrl = url;
                if(url.includes('drive.google.com') && url.includes('export=view')) {
                    downloadUrl = url.replace('export=view', 'export=download');
                }
                
                return `<span style="display:inline-flex; align-items:center; gap:4px; vertical-align:middle; margin-right:5px;">
                    <a href="${url}" target="_blank" style="text-decoration:none; background:#e3f2fd; color:#1565c0; padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid #90caf9;">
                        <i class="fas fa-eye"></i> ‡∏î‡∏π
                    </a>
                    <a href="${downloadUrl}" target="_blank" style="text-decoration:none; background:#ffebee; color:#c62828; padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid #ef9a9a;" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ">
                        <i class="fas fa-save"></i>
                    </a>
                </span>`;
            });
        }

        window.onload = function() {
            const saved = localStorage.getItem('kamky_user');
            if (saved) { currentUser = JSON.parse(saved); initApp(); } 
            else { document.getElementById('filterDate').valueAsDate = new Date(); }
        };

        async function doLogin() {
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            const msg = document.getElementById('loginMsg');
            if(!u || !p) { msg.innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; return; }
            msg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            try {
                const res = await fetch(API_URL, { method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({action:'login', username:u, password:p}) });
                const d = await res.json();
                if(d.status === 'success') {
                    currentUser = d.user;
                    localStorage.setItem('kamky_user', JSON.stringify(currentUser));
                    initApp();
                } else { msg.innerHTML = `‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`; msg.style.color = 'red'; }
            } catch(e) { msg.innerText = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'; msg.style.color = 'red'; }
        }

        function doLogout() { localStorage.removeItem('kamky_user'); location.reload(); }

        function initApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appTitle').innerHTML += ` <span class="user-profile-badge" onclick="userProfile()"><i class="fas fa-user"></i> ${currentUser.name}</span>`;
            document.getElementById('btnLogout').style.display = 'flex';
            if(!document.getElementById('filterDate').value) document.getElementById('filterDate').valueAsDate = new Date();
            const isUser = currentUser.role !== 'admin';
            if (isUser) { ['btnPrint','btnExcel','btnReset'].forEach(id => document.getElementById(id).style.display = 'none'); } 
            else { document.getElementById('btnAdmin').style.display = 'flex'; }
            loadData();
        }

        async function loadData() {
            clearSearchUI();
            const date = document.getElementById('filterDate').value;
            const container = document.getElementById('contractList');
            container.innerHTML = '<div class="loading-state">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_tracking', date: date }) });
                const data = await response.json();
                currentTrackingData = data.contracts || []; globalSummary = data.summary || {};
                renderDashboard(data, date, false);
            } catch (e) { container.innerHTML = '<div class="loading-state" style="color:red">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>'; }
        }

        async function doGlobalSearch() {
            const keyword = document.getElementById('searchInput').value.trim();
            if(!keyword) return;

            isSearchMode = true;
            document.getElementById('statContainer').style.display = 'none';
            document.getElementById('searchResultTitle').style.display = 'block';
            document.getElementById('txtSearchKeyword').innerText = keyword;
            
            const container = document.getElementById('contractList');
            container.innerHTML = '<div class="loading-state">üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';

            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'search_tracking', keyword: keyword }) });
                const data = await response.json();
                renderDashboard({ contracts: data.contracts, summary: {} }, null, true);
            } catch (e) { container.innerHTML = '<div class="loading-state" style="color:red">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>'; }
        }

        function clearSearch() { document.getElementById('searchInput').value = ''; clearSearchUI(); loadData(); }
        function clearSearchUI() { isSearchMode = false; document.getElementById('statContainer').style.display = 'grid'; document.getElementById('searchResultTitle').style.display = 'none'; }
        
        function renderDashboard(data, selectedDate, forceShowAll) {
            const container = document.getElementById('contractList'); container.innerHTML = "";
            const hidden = JSON.parse(localStorage.getItem('hiddenContracts') || '[]').map(String);
            
            const selectedDateThai = selectedDate ? formatDateToThai(selectedDate) : "";
            let selectedYearTH = "";
            let selectedMonthOnly = "";
            if(selectedDate) {
               let d = new Date(selectedDate);
               selectedYearTH = d.getFullYear() + 543;
               selectedMonthOnly = ("0" + (d.getMonth() + 1)).slice(-2);
            }
            const selectedMonthStr = `${selectedYearTH}-${selectedMonthOnly}`; 
            
            let groups = { searchRes: [], overdue: [], pending: [], normal: [], postpone: [] };

            let strictDailyTarget = 0;   
            let strictDailyCollected = 0;
            let strictMonthlyTarget = 0; 
            let strictMonthlyCollected = 0;

            if (data.contracts) {
                data.contracts.forEach(c => {
                    const amount = parseFloat(c.amount || 0);
                    const isPaid = ['Paid', 'Close', '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î'].includes(c.status);
                    
                    const isPostponedToToday = (c.postpone_date === selectedDateThai);
                    const isDueToday = (c.due_date === selectedDateThai);
                    const hasPostpone = (c.postpone_date && c.postpone_date !== "-" && c.postpone_date !== "");
                    
                    let isTargetToday = false;
                    if (isPostponedToToday) isTargetToday = true;
                    else if (isDueToday && !hasPostpone) isTargetToday = true;

                    if (isTargetToday) {
                        strictDailyTarget += amount;
                        if (isPaid) strictDailyCollected += amount;
                    }

                    if (c.due_date) {
                        const parts = c.due_date.split('/'); 
                        if(parts.length === 3) {
                            const cMonthStr = `${parts[2]}-${parts[1]}`;
                            if (cMonthStr === selectedMonthStr) {
                                strictMonthlyTarget += amount;
                                if (isPaid) strictMonthlyCollected += amount;
                            }
                        }
                    }

                    if (!forceShowAll && hidden.includes(String(c.c_no))) return;
                    
                    let shouldShow = forceShowAll ? true : (isTargetToday || c.overdue_count > 0 || ['Pending_Approve', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î'].includes(c.status));

                    if (shouldShow) {
                        let amt = parseFloat(c.amount) * (c.overdue_count > 1 ? c.overdue_count : 1);
                        
                        if (c.original_due_date !== selectedDateThai && c.postpone_date === selectedDateThai) {
                            c.worksheetStatus = `‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å ${c.original_due_date}`;
                        } else {
                            if (['Pending_Approve', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î'].includes(c.status)) {
                                c.worksheetStatus = c.status === '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î' ? '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î' : '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                            } else {
                                c.worksheetStatus = c.overdue_count > 0 ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : '‡∏õ‡∏Å‡∏ï‡∏¥';
                            }
                        }

                        let item = { ...c, finalAmount: amt, hasPostpone: hasPostpone };
                        
                        if (forceShowAll) {
                            groups.searchRes.push(item);
                        } else {
                            // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Postpone ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô Overdue
                            if (c.status === 'Pending_Approve' || c.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' || c.status === '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î') {
                                groups.pending.push(item);
                            } 
                            else if (isPostponedToToday) { 
                                groups.postpone.push(item);
                            }
                            else if (c.overdue_count > 0) {
                                groups.overdue.push(item);
                            } 
                            else {
                                groups.normal.push(item); 
                            }
                        }
                    }
                });
            }

            if (!forceShowAll) {
                updateCharts(strictDailyTarget, strictDailyCollected, strictMonthlyTarget, strictMonthlyCollected);
            }

            filteredData = [];
            if(forceShowAll) {
                 filteredData = [...groups.searchRes];
            } else {
                 filteredData = [...groups.pending, ...groups.normal, ...groups.postpone, ...groups.overdue];
            }

            if (filteredData.length === 0) { container.innerHTML = '<div class="loading-state">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>'; return; }

            if (forceShowAll) {
                renderAccordionSection(container, 'üìÑ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', groups.searchRes, 'open');
            } else {
                renderAccordionSection(container, '‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Pending)', groups.pending, 'open');
                renderAccordionSection(container, 'üìÖ ‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today)', groups.normal, 'open');
                renderAccordionSection(container, '‚è∞ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Postponed)', groups.postpone, 'open');
                renderAccordionSection(container, '‚ùó ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (Overdue)', groups.overdue, 'open');
            }
        }

        function renderAccordionSection(container, title, items, defaultState) {
            if(items.length === 0) return;
            const id = 'acc_' + Math.random().toString(36).substr(2, 9);
            const htmlItems = items.map(c => createCardHtml(c)).join('');
            
            container.innerHTML += `
            <div class="accordion-group">
                <div class="accordion-header" onclick="toggleAccordion('${id}')">
                    <span>${title}</span>
                    <div style="display:flex; align-items:center;">
                        <span class="badge-count">${items.length}</span>
                        <i class="fas fa-chevron-down" id="icon_${id}"></i>
                    </div>
                </div>
                <div id="${id}" class="accordion-content ${defaultState==='open'?'active':''}">
                    ${htmlItems}
                </div>
            </div>`;
        }

        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById('icon_' + id);
            if(content.classList.contains('active')) {
                content.classList.remove('active');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('active');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function createCardHtml(c) {
            const isAdmin = currentUser.role === 'admin';
            let cardClass = isSearchMode ? "card-search-result" : "card-normal"; 
            let statusHtml = `<span class="status-text text-green"><i class="fas fa-check-circle"></i> ‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
            let hasPaymentNote = c.last_note && c.last_note.includes('‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞');
            
            if (c.status === 'Pending_Approve' || c.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') { 
                cardClass = "card-pending-approve"; 
                if(isAdmin) statusHtml = `<span class="status-text text-orange" onclick="adminApprove('${c.c_no}', ${c.row_index}, '${c.request_date}', '${c.last_note || ''}', 'postpone')">‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏Å‡∏î)</span>`;
                else statusHtml = `<span class="status-text text-orange">‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>`;
            } 
            else if (c.status === '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î') {
                cardClass = "card-pending-approve"; 
                if(isAdmin) statusHtml = `<span class="status-text text-red" style="cursor:pointer;" onclick="adminApprove('${c.c_no}', ${c.row_index}, '-', '${c.last_note || ''}', 'close')">üèÅ ‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î (‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</span>`;
                else statusHtml = `<span class="status-text text-red">üèÅ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</span>`;
            }
            else if (c.hasPostpone) { cardClass = "card-postpone"; statusHtml = `<span class="status-text text-purple">‚è∞ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô: ${c.postpone_date}</span>`; } 
            else if (c.overdue_count > 0) { cardClass = "card-overdue"; statusHtml = `<span class="status-text text-red">‚ùó ‡∏Ñ‡πâ‡∏≤‡∏á ${c.overdue_count} ‡∏á‡∏ß‡∏î</span>`; }
            else if (c.status === 'Close' || c.status === 'Paid') { statusHtml = `<span class="status-text text-green">‚úÖ ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß (${c.last_payment_date})</span>`; }

            if (hasPaymentNote) {
                let noteContent = linkify(c.last_note);
                statusHtml += `<div style="font-size:11px; color:#4361ee; background:#eef2ff; padding:6px; border-radius:4px; margin-top:4px; border:1px solid #dce6ff; white-space:normal; word-break:break-all;">üí∞ ${noteContent}</div>`;
            }

            let menuButton = isAdmin ? `<button class="btn-kebab" style="margin-left:5px;" onclick="openManageMenu(${c.row_index},'${c.b_name}','${c.c_no}')">‚ãÆ</button>` : '';
            let actionButtonsHtml = '', gridClass = '';
            
            const hasExtraInfo = (c.contact_image && c.contact_image !== "" && c.contact_image !== "-");
            const infoBtn = hasExtraInfo 
                ? `<button class="btn-act btn-act-info" onclick="openContactImage('${c.c_no}')"><i class="fas fa-address-card"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>`
                : `<button class="btn-act btn-disabled" disabled><i class="fas fa-address-card"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>`;
            const contractBtn = `<button class="btn-act btn-act-contract" onclick="openContractPopup('${c.c_no}')"><i class="fas fa-file-contract"></i> ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</button>`;

            if (isAdmin) {
                gridClass = 'grid-admin-actions';
                actionButtonsHtml = `
                    <a href="tel:${c.b_mobile}" class="btn-act btn-act-call"><i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£</a>
                    ${infoBtn}
                    ${contractBtn}
                    <button class="btn-act btn-act-pay" onclick="openPay('${c.c_no}')"><i class="fas fa-wallet"></i> ‡∏à‡πà‡∏≤‡∏¢</button>
                    <button class="btn-act btn-act-postpone" style="grid-column: 1 / -1;" onclick="openPostpone(${c.row_index},'${c.b_name}', '${c.postpone_date||''}')"><i class="fas fa-calendar-check"></i> ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
                `;
            } else {
                gridClass = 'grid-user-actions';
                const isPending = (c.status === 'Pending_Approve' || c.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' || c.status === '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î');
                const payBtn = isPending 
                    ? `<button class="user-checkbox-btn btn-disabled" disabled><i class="fas fa-clock"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>`
                    : `<button class="user-checkbox-btn" onclick="userReqPay('${c.c_no}')"><i class="far fa-check-square"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞</button>`;
                const closeBtn = isPending
                    ? `<button class="user-checkbox-btn btn-disabled" disabled><i class="fas fa-flag-checkered"></i> ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</button>`
                    : `<button class="user-checkbox-btn" onclick="userReqClose('${c.c_no}')" style="color:#c0392b;"><i class="fas fa-flag-checkered"></i> ‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</button>`;

                actionButtonsHtml = `
                    <a href="tel:${c.b_mobile}" class="btn-act btn-act-call"><i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£</a>
                    ${infoBtn}
                    ${contractBtn}
                    ${payBtn}
                    <button class="user-checkbox-btn" onclick="userReqPostpone('${c.c_no}')"><i class="far fa-clock"></i> ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î</button>
                    ${closeBtn}
                    <button class="user-checkbox-btn" style="grid-column: 1 / -1;" onclick="userAddNote('${c.c_no}')"><i class="fas fa-pen"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</button>
                `;
            }

            return `
            <div class="cust-card ${cardClass}">
                <div class="cust-header"><div class="cust-info"><h3>${c.b_name}</h3><span class="cust-id">#${c.c_no}</span></div><div class="status-badge">${statusHtml}</div>${menuButton}</div>
                <div class="cust-body"><div><div class="contact-line"><i class="fas fa-phone"></i> ${c.b_mobile}</div><div class="contact-line">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${c.installment_no}</div></div><div style="text-align:right"><span style="font-size:10px; color:#777;">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span><div class="amount-val">‡∏ø${c.finalAmount.toLocaleString()}</div></div></div>
                <div class="cust-actions ${gridClass}">${actionButtonsHtml}</div>
            </div>`;
        }

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ (‡πÅ‡∏ô‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ)
        async function userReqPay(cNo) {
            const { value: formValues } = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
                html: `
                    <div style="text-align:left; font-size:14px; margin-bottom:5px;">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</div>
                    <input type="file" id="swal-input-file" class="swal2-input" accept="image/*" multiple style="width:80%; margin:0 auto; display:block;">
                    <input type="text" id="swal-input-note" class="swal2-input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" style="margin-top:10px;">
                `,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#27ae60',
                preConfirm: () => {
                    const fileInput = document.getElementById('swal-input-file');
                    const noteInput = document.getElementById('swal-input-note').value;
                    // ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≠‡∏Å
                    return { files: fileInput.files, note: noteInput };
                }
            });

            if (formValues) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                try {
                    let slips = [];
                    // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå
                    if (formValues.files.length > 0) {
                        for(let i=0; i<formValues.files.length; i++){
                            const file = formValues.files[i];
                            const base64Str = await toBase64(file);
                            slips.push({ image: base64Str, name: `slip_${cNo}_${new Date().getTime()}_${i}.jpg`, mime: file.type });
                        }
                    }

                    await sendUserRequest('request_pay', cNo, { 
                        note: '‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô: ' + (formValues.note || '-'),
                        slips: slips 
                    });
                } catch (error) { Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå', 'error'); }
            }
        }

        async function userReqClose(cNo) {
            const { value: formValues } = await Swal.fire({
                title: '‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
                html: `
                    <p style="font-size:14px; color:#c0392b; margin-bottom:10px;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${cNo}</p>
                    <div style="text-align:left; font-size:14px; margin-bottom:5px;">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏¢‡∏≠‡∏î‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô):</div>
                    <input type="file" id="swal-input-file-close" class="swal2-input" accept="image/*" style="width:80%; margin:0 auto; display:block;">
                    <input type="text" id="swal-input-note-close" class="swal2-input" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" style="margin-top:10px;">
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#e74c3c',
                preConfirm: () => {
                    const fileInput = document.getElementById('swal-input-file-close');
                    const noteInput = document.getElementById('swal-input-note-close').value;
                    if (fileInput.files.length === 0) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î'); return false; }
                    return { file: fileInput.files[0], note: noteInput };
                }
            });

            if (formValues) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                try {
                    const base64Str = await toBase64(formValues.file);
                    await sendUserRequest('request_close', cNo, { note: '‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ' + (formValues.note || '-'), slip_image: base64Str, slip_name: `close_${cNo}_${new Date().getTime()}.jpg`, slip_mime: formValues.file.type });
                } catch (e) { Swal.fire('Error', '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
            }
        }

        async function userReqPostpone(cNo) { Swal.fire({title:'‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î', input:'date'}).then(r=>{if(r.value) sendUserRequest('request_postpone', cNo, {new_date:r.value});}); }
        async function userAddNote(cNo) { Swal.fire({input:'text', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}).then(r=>{if(r.value) sendUserRequest('add_daily_note', cNo, {note:r.value});}); }
        
        async function sendUserRequest(act, cNo, pl) { 
            Swal.showLoading(); 
            try {
                await fetch(API_URL, { method:'POST', body:JSON.stringify({ action:'user_action_log', sub_action:act, c_no:cNo, user:currentUser.username, ...pl }) }); 
                Swal.fire({icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer:1500, showConfirmButton:false}); 
                loadData(); 
            } catch(e) { Swal.fire('Error', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'); }
        }

        // ‚úÖ Admin: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        // üî¥ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡πÉ‡∏ä‡πâ URL ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        async function adminApprove(cNo, rowIndex, reqDate, details, type) {
            let title = type === 'close' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (Close)' : '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            let confirmBtn = type === 'close' ? 'üèÅ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î' : '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            let actionType = type === 'close' ? 'close_account' : 'approve_contract'; 
            
            Swal.fire({ 
                title: title, 
                html: `<p>‡∏™‡∏±‡∏ç‡∏ç‡∏≤ #${cNo}</p><h2 style="color:#4361ee;">${reqDate !== '-' ? reqDate : ''}</h2><p>${details}</p>`, 
                icon: 'question', 
                showCancelButton: true, 
                showDenyButton: true, 
                denyButtonText: '‚ùå ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö (‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)',
                confirmButtonText: confirmBtn, 
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' 
            }).then(async (result) => { 
                if (result.isConfirmed) { 
                    // 1. ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                    Swal.showLoading(); 
                    if (type === 'postpone' && reqDate && reqDate !== '-') { 
                        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'postpone', row_index: rowIndex, new_date: reqDate }) }); 
                    } 
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: actionType, row_index: rowIndex }) }); 
                    
                    // 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ñ‡∏≤‡∏° Admin ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏õ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏•‡∏¢‡πÑ‡∏´‡∏°
                    Swal.fire({
                        title: '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
                        icon: 'success',
                        showCancelButton: true,
                        confirmButtonText: 'üñ®Ô∏è ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à',
                        cancelButtonText: '‡∏õ‡∏¥‡∏î',
                        confirmButtonColor: '#2c3e50'
                    }).then((r) => {
                        if (r.isConfirmed) {
                            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Bill ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                            window.open(`https://kamkywork.github.io/kamkybill-app/?ref=${encodeURIComponent(cNo)}`, '_blank');
                        }
                        loadData(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
                    });

                } else if (result.isDenied) {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                    const { value: reason } = await Swal.fire({
                        title: '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö',
                        input: 'text',
                        inputPlaceholder: '‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î, ‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á',
                        showCancelButton: true
                    });
                    
                    if (reason) {
                        Swal.showLoading();
                        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'reject_request', row_index: rowIndex, reason: reason }) });
                        Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success').then(() => loadData());
                    }
                }
            });
        }

        function openPostpone(idx, name, currentVal) {
            Swal.fire({ title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', html: `<div style="margin-bottom:10px;">‡πÄ‡∏î‡∏¥‡∏°: <b>${currentVal || '-'}</b></div><input type="date" id="swal-date" class="swal2-input">`, showDenyButton: true, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', denyButtonText: '‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', cancelButtonText: '‡∏õ‡∏¥‡∏î' }).then(r => { if (r.isConfirmed) executeAction({ action: 'postpone', row_index: idx, new_date: document.getElementById('swal-date').value }); else if (r.isDenied) executeAction({ action: 'postpone', row_index: idx, new_date: '' }); });
        }

        function showSummary(type) { Swal.fire({ title: `‡∏™‡∏£‡∏∏‡∏õ${type==='daily'?'‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô':'‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}`, showCancelButton:true, confirmButtonText:'‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô' }).then(r=>{if(r.isConfirmed) printSummaryReport(type)}); }

        // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î 4 ‡∏™‡∏µ (‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ô‡∏ö)
        function printSummaryReport(type) {
            const rawDate = document.getElementById('filterDate').value;
            const dateStr = formatDateToThai(rawDate);
            let dateObj = new Date(rawDate);
            let yearTH = dateObj.getFullYear() + 543;
            const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            const monthStr = monthNames[dateObj.getMonth()];
            const currentMonthStr = `${yearTH}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}`;
            
            let listPaid = [], listDue = [], listOverdue = [], listOldOverdue = [];
            let totalOldOverdue = 0;

            // --- 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Logic ‡πÄ‡∏î‡∏¥‡∏°) ---
            currentTrackingData.forEach(c => {
                const amount = parseFloat(c.amount);
                let cDateParts = c.due_date.split('/');
                let cMonthStr = cDateParts.length === 3 ? `${cDateParts[2]}-${cDateParts[1]}` : ''; 
                
                let isPaid = ['Paid', 'Close', '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î'].includes(c.status);
                
                // ‡πÅ‡∏¢‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ (Old Overdue)
                if (!isPaid && cMonthStr < currentMonthStr && cMonthStr !== '') {
                    listOldOverdue.push(c);
                    totalOldOverdue += amount;
                }

                let isTargetDay = false;
                if(c.postpone_date === dateStr) isTargetDay = true;
                else if(c.due_date === dateStr && (!c.postpone_date || c.postpone_date==='-')) isTargetDay = true;
                else if(isPaid && (c.update_date === dateStr || c.last_payment_date === dateStr)) isTargetDay = true;

                let includeInReport = false;
                if (type === 'daily') {
                    if (isTargetDay) includeInReport = true;
                    // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ listOldOverdue ‡∏°‡∏≤‡∏õ‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á main ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏î‡∏á
                } else {
                    if (cMonthStr === currentMonthStr) includeInReport = true;
                    if (!isPaid && cMonthStr < currentMonthStr) includeInReport = true;
                }

                if (includeInReport) {
                    if (isPaid) listPaid.push(c);
                    else if (c.overdue_count > 0 || (cMonthStr < currentMonthStr)) listOverdue.push(c);
                    else listDue.push(c);
                }
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î
            let card1_Label, card1_Val, card1_Color = "bg-red";
            let card2_Label, card2_Val, card2_Color = "bg-blue";
            let card3_Label, card3_Val, card3_Color = "bg-green";
            let card4_Label, card4_Val, card4_Color = "bg-orange";
            let percent = 0;

            if (type === 'monthly') {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å Dashboard ‡πÄ‡∏î‡∏¥‡∏°)
                let totalMonthTarget = 0, totalMonthCollected = 0;
                currentTrackingData.forEach(c => {
                    let cDateParts = c.due_date.split('/');
                    let cMonthStr = cDateParts.length === 3 ? `${cDateParts[2]}-${cDateParts[1]}` : '';
                    if (cMonthStr === currentMonthStr) {
                        totalMonthTarget += parseFloat(c.amount);
                        if (['Paid', 'Close', '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î'].includes(c.status)) totalMonthCollected += parseFloat(c.amount);
                    }
                });
                
                let remaining = totalMonthTarget - totalMonthCollected;
                percent = totalMonthTarget > 0 ? ((totalMonthCollected/totalMonthTarget)*100).toFixed(1) : 0;

                card1_Label = "‡∏Ñ‡πâ‡∏≤‡∏á‡∏¢‡∏Å‡∏°‡∏≤"; card1_Val = totalOldOverdue;
                card2_Label = "‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"; card2_Val = totalMonthTarget;
                card3_Label = "‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°"; card3_Val = totalMonthCollected;
                card4_Label = "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö"; card4_Val = Math.max(0, remaining);

            } else {
                // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                let todayTarget = listPaid.reduce((a,b)=>a+parseFloat(b.amount),0) + listDue.reduce((a,b)=>a+parseFloat(b.amount),0) + listOverdue.reduce((a,b)=>a+parseFloat(b.amount),0); // ‡∏Ñ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
                let todayCollected = listPaid.reduce((a,b)=>a+(parseFloat(b.amount_paid||b.amount)),0);
                let todayRemaining = Math.max(0, todayTarget - todayCollected);
                percent = todayTarget > 0 ? ((todayCollected/todayTarget)*100).toFixed(1) : 0;

                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏™‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏õ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ
                // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö (4 ‡∏ä‡πà‡∏≠‡∏á) ‡∏à‡∏∞‡πÉ‡∏ä‡πâ ‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏™‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
                card1_Label = "‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏™‡∏° (‡πÄ‡∏Å‡πà‡∏≤)"; card1_Val = totalOldOverdue;
                card2_Label = "‡πÄ‡∏õ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"; card2_Val = todayTarget;
                card3_Label = "‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"; card3_Val = todayCollected;
                card4_Label = "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"; card4_Val = todayRemaining;
            }

            // --- 2. ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÅ‡∏•‡∏∞ CSS (Design ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ) ---
            const now = new Date();
            const fileNameDate = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate()}`;
            const fileName = `Report_${type}_${dateStr.replace(/\//g,'-')}_${fileNameDate}`;
            
            const style = `
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700;800&display=swap');
                    body { font-family: 'Sarabun', sans-serif; padding: 20px; background: #f8f9fa; color: #333; }
                    .report-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); max-width: 900px; margin: 0 auto; }
                    
                    /* Header Style */
                    .header-title { text-align: center; margin-bottom: 30px; }
                    .header-title h2 { margin: 0; font-size: 22px; color: #2b2d42; font-weight: 800; display:flex; align-items:center; justify-content:center; gap:8px; }
                    .header-title span { font-size: 14px; color: #555; margin-top: 5px; display:block; }
                    
                    /* Card Grid Style (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö) */
                    .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
                    .card { border-radius: 10px; padding: 20px 10px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                    .card h3 { margin: 0 0 5px 0; font-size: 14px; font-weight: 500; opacity: 0.95; }
                    .card h2 { margin: 0; font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
                    
                    /* ‡∏™‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î */
                    .bg-red { background-color: #e74c3c; }    /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á (‡∏Ñ‡πâ‡∏≤‡∏á‡∏¢‡∏Å‡∏°‡∏≤) */
                    .bg-blue { background-color: #4361ee; }   /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏õ‡πâ‡∏≤) */
                    .bg-green { background-color: #27ae60; }  /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ) */
                    .bg-orange { background-color: #f39c12; } /* ‡∏™‡∏µ‡∏™‡πâ‡∏° (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö) */

                    .percent-text { text-align: center; color: #4361ee; font-weight: 700; font-size: 14px; margin-bottom: 30px; }

                    /* Table Style */
                    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; margin-bottom: 20px; }
                    th { background: #eee; padding: 8px; border: 1px solid #ddd; text-align: left; color: #333; font-weight: 700; }
                    td { padding: 8px; border: 1px solid #ddd; vertical-align: middle; }
                    
                    .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; }
                    .status-paid { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
                    .status-due { background: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }
                    .status-overdue { background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
                    
                    .section-head { margin-top: 15px; font-size: 15px; font-weight: bold; padding: 5px 10px; background: #f8f9fa; border-left: 5px solid #ccc; color: #333; }
                    .summary-table td { font-weight: bold; }
                    .text-right { text-align: right; }
                    .text-center { text-align: center; }
                    
                    .hide-on-print { margin-top:20px; text-align:center; display:flex; justify-content:center; gap:10px; }
                    @media print { .hide-on-print { display: none; } body { background: white; -webkit-print-color-adjust: exact; } .report-box { box-shadow: none; padding:0; } }
                </style>`;

            const createRows = (list, type) => {
                if(list.length === 0) return `<tr><td colspan="5" class="text-center" style="color:#999;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -</td></tr>`;
                return list.map((i, idx) => {
                    let statusBadge = '';
                    let note = i.last_note || '';
                    if (type === 'paid') statusBadge = `<span class="badge status-paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>`;
                    else if (type === 'due') statusBadge = `<span class="badge status-due">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span>`;
                    else if (type === 'overdue') {
                        let ovTxt = i.overdue_count > 0 ? ` (${i.overdue_count} ‡∏á‡∏ß‡∏î)` : '';
                        statusBadge = `<span class="badge status-overdue">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞${ovTxt}</span>`;
                    }
                    if (i.postpone_date && i.postpone_date !== '-' && type !== 'paid') {
                        note = `<span style="color:#6f42c1; font-size:11px;">[‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤]</span> ` + note;
                    }
                    note = linkify(note);
                    return `<tr><td class="text-center">${idx+1}</td><td>${i.c_no} <br><span style="font-size:11px; color:#666;">${i.b_name}</span></td><td class="text-right">${parseFloat(i.amount).toLocaleString()}</td><td class="text-center">${statusBadge}</td><td>${note}</td></tr>`;
                }).join('');
            };

            const htmlContent = `
                <div class="report-box" id="captureArea">
                    <div class="header-title">
                        <h2><i class="fas fa-chart-bar" style="color:#e74c3c;"></i> ‡∏™‡∏£‡∏∏‡∏õ${type==='daily'?'‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (Daily)':'‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Monthly)'}</h2>
                        <span>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthStr} ${yearTH} ${type==='daily' ? '(‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ' + dateStr + ')' : ''}</span>
                    </div>

                    <div class="summary-grid">
                        <div class="card ${card1_Color}">
                            <h3>${card1_Label}</h3>
                            <h2>${card1_Val.toLocaleString()}</h2>
                        </div>
                        <div class="card ${card2_Color}">
                            <h3>${card2_Label}</h3>
                            <h2>${card2_Val.toLocaleString()}</h2>
                        </div>
                        <div class="card ${card3_Color}">
                            <h3>${card3_Label}</h3>
                            <h2>${card3_Val.toLocaleString()}</h2>
                        </div>
                        <div class="card ${card4_Color}">
                            <h3>${card4_Label}</h3>
                            <h2>${card4_Val.toLocaleString()}</h2>
                        </div>
                    </div>
                    <div class="percent-text">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${percent}%</div>

                    <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

                    <div class="section-head" style="border-color:#198754; color:#198754;">1. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß (Paid)</div>
                    <table><thead><tr><th width="5%">#</th><th width="30%">‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏ä‡∏∑‡πà‡∏≠</th><th width="15%" class="text-right">‡∏¢‡∏≠‡∏î</th><th width="20%" class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th width="30%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody>${createRows(listPaid, 'paid')}</tbody></table>
                    
                    <div class="section-head" style="border-color:#ffc107; color:#b58900;">2. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (Due)</div>
                    <table><thead><tr><th width="5%">#</th><th width="30%">‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏ä‡∏∑‡πà‡∏≠</th><th width="15%" class="text-right">‡∏¢‡∏≠‡∏î</th><th width="20%" class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th width="30%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody>${createRows(listDue, 'due')}</tbody></table>
                    
                    <div class="section-head" style="border-color:#dc3545; color:#dc3545;">3. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (Overdue)</div>
                    <table><thead><tr><th width="5%">#</th><th width="30%">‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏ä‡∏∑‡πà‡∏≠</th><th width="15%" class="text-right">‡∏¢‡∏≠‡∏î</th><th width="20%" class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th width="30%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody>${createRows(listOverdue, 'overdue')}</tbody></table>
                    
                    <div class="section-head" style="background:#2b2d42; color:white; border:none; text-align:center;">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                    <table class="summary-table">
                        <tr style="background:#e8f8f5;"><td>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß (Paid)</td><td class="text-right" style="color:#198754;">${(listPaid.reduce((a,b)=>a+(parseFloat(b.amount_paid||b.amount)),0)).toLocaleString()} ‡∏ö‡∏≤‡∏ó</td><td class="text-center">${listPaid.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
                        <tr style="background:#fffdf5;"><td>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (Due)</td><td class="text-right" style="color:#d63384;">${(listDue.reduce((a,b)=>a+parseFloat(b.amount),0)).toLocaleString()} ‡∏ö‡∏≤‡∏ó</td><td class="text-center">${listDue.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
                        <tr style="background:#f8d7da;"><td>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (Overdue)</td><td class="text-right" style="color:#dc3545;">${(listOverdue.reduce((a,b)=>a+parseFloat(b.amount),0)).toLocaleString()} ‡∏ö‡∏≤‡∏ó</td><td class="text-center">${listOverdue.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
                    </table>
                </div>`;

            let win = window.open('', '_blank');
            win.document.write(`<html><head><title>${fileName}</title><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">${style}<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script></head><body>${htmlContent}<div class="hide-on-print"><button onclick="window.print()" style="padding:10px 20px; cursor:pointer; background:#2b2d42; color:white; border:none; border-radius:5px;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button><button onclick="saveAsImage()" style="padding:10px 20px; cursor:pointer; background:#27ae60; color:white; border:none; border-radius:5px;">üì∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button></div><script>function saveAsImage() { const element = document.getElementById('captureArea'); html2canvas(element, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => { const link = document.createElement('a'); link.download = '${fileName}.jpg'; link.href = canvas.toDataURL('image/jpeg'); link.click(); }); }<\/script></body></html>`);
            win.document.close();
        }

        async function openContractPopup(cNo) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const res = await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'get_contract_image', c_no: String(cNo) }) 
                });
                const d = await res.json();
                
                if(d.status === 'success') {
                    const imgUrl = d.url + "&t=" + new Date().getTime();
                    
                    Swal.fire({ 
                        imageUrl: imgUrl, 
                        width: '95%', 
                        imageAlt: 'Contract Image',
                        showCloseButton: true, 
                        confirmButtonText: '‡∏õ‡∏¥‡∏î',
                        footer: `<a href="${d.url}" target="_blank" style="color:#4361ee; font-weight:bold; text-decoration:underline;">‡∏´‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</a>`
                    });
                } else {
                    Swal.fire({ icon: 'warning', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏™‡∏±‡∏ç‡∏ç‡∏≤' });
                }
            } catch(e) {
                console.error(e);
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î' });
            }
        }
        
        async function openContactImage(cNo) { 
            Swal.showLoading(); 
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_contract_image', c_no: cNo, type: 'contact_aw' }) }); 
                const d = await res.json(); 
                if(d.status==='success') Swal.fire({ imageUrl: d.url, width: '95%', showCloseButton: true, confirmButtonText: '‡∏õ‡∏¥‡∏î' }); 
                else Swal.fire({ icon: 'warning', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (AW)' }); 
            } catch(e) { Swal.fire('Error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
        }

        function formatDateToThai(dateString) { 
            if(!dateString) return ""; 
            const p = dateString.split('-'); 
            let year = parseInt(p[0]) + 543;
            return `${p[2]}/${p[1]}/${year}`; 
        }
        
        function updateCharts(dailyTarget, dailyCollected, monthlyTarget, monthlyCollected) {
            const remainingDaily = Math.max(0, dailyTarget - dailyCollected);
            document.getElementById('txtTodayCollected').innerText = dailyCollected.toLocaleString();
            document.getElementById('txtTodayPending').innerText = remainingDaily.toLocaleString();
            document.getElementById('txtTodayPercent').innerText = dailyTarget > 0 ? Math.round((dailyCollected / dailyTarget) * 100) + '%' : '0%';
            updateChart('dailyChart', 'daily', dailyCollected, remainingDaily);

            const remainingMonth = Math.max(0, monthlyTarget - monthlyCollected);
            document.getElementById('txtMonthCollected').innerText = monthlyCollected.toLocaleString();
            document.getElementById('txtMonthTarget').innerText = monthlyTarget.toLocaleString();
            document.getElementById('txtMonthPercent').innerText = monthlyTarget > 0 ? Math.round((monthlyCollected / monthlyTarget) * 100) + '%' : '0%';
            updateChart('monthlyChart', 'monthly', monthlyCollected, remainingMonth);
        }

        function updateChart(id, type, val1, val2) { 
            const ctx = document.getElementById(id).getContext('2d'); 
            let colors = type === 'daily' ? ['#2ec4b6', '#e71d36'] : ['#4361ee', '#e71d36']; 
            if(val2 === 0) colors = type === 'daily' ? ['#2ec4b6', '#edf2f4'] : ['#4361ee', '#edf2f4'];
            let config = { type: 'doughnut', data: { datasets: [{ data: [val1, val2], backgroundColor: colors, borderWidth: 0 }] }, options: { cutout: '85%', plugins: { legend: { display: false } }, animation: { duration: 0 } } }; 
            if(type==='daily'){ if(dailyChartInstance) dailyChartInstance.destroy(); dailyChartInstance=new Chart(ctx, config); } 
            else{ if(monthlyChartInstance) monthlyChartInstance.destroy(); monthlyChartInstance=new Chart(ctx, config); } 
        }

        function exportToExcel() { if (!filteredData.length) return; let csv = "data:text/csv;charset=utf-8,\uFEFF‡∏•‡∏≥‡∏î‡∏±‡∏ö,‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏ä‡∏∑‡πà‡∏≠,‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏á‡∏ß‡∏î,‡∏¢‡∏≠‡∏î,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n"; filteredData.forEach((i, idx) => csv += `${idx+1},"${i.c_no}","${i.b_name}","${i.b_mobile}",${i.installment_no},${i.finalAmount},"${i.status}"\n`); const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "Report.csv"; link.click(); }
        function openPay(c_no) { window.open(`https://kamkywork.github.io/kamkybill-app/?ref=${c_no}`, '_blank'); }
        function hideContract(c_no) { let h=JSON.parse(localStorage.getItem('hiddenContracts')||'[]'); if(!h.includes(String(c_no))){ h.push(String(c_no)); localStorage.setItem('hiddenContracts',JSON.stringify(h)); loadData(); } }
        function resetHidden() { localStorage.removeItem('hiddenContracts'); loadData(); }
        async function openManageMenu(idx, name, c_no) { const { value: action } = await Swal.fire({ title: name, input: 'select', inputOptions: { 'hide': 'üëÅÔ∏è ‡∏ã‡πà‡∏≠‡∏ô', 'cancel_contract': '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤', 'close_account': '‚úÖ ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î' }, showCancelButton: true }); if(action){ if(action==='hide') hideContract(c_no); else Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?',showCancelButton:true}).then(r=>{if(r.isConfirmed) executeAction({action,c_no,row_index:idx})}); } }
        async function executeAction(p) { Swal.fire({ title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() }); try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(p) }); Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false }); loadData(); } catch (e) { Swal.fire('Error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); } }
        
        function userProfile() { Swal.fire({ title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', html: `<b>${currentUser.name}</b><br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${currentUser.role}`, showDenyButton: true, confirmButtonText: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', denyButtonText: '‡∏õ‡∏¥‡∏î' }).then(r => { if(r.isConfirmed) changePass(); }); }
        async function changePass() { const { value: p } = await Swal.fire({ title: '‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà', input: 'password' }); if(p) { await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'change_password', username:currentUser.username, new_pass:p}) }); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ
        function printReport() {
            if (!filteredData || filteredData.length === 0) { Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ', 'warning'); return; }
            const dateRaw = document.getElementById('filterDate').value;
            const dateStr = formatDateToThai(dateRaw);
            const now = new Date();
            const printTime = `${now.getHours()}:${("0" + now.getMinutes()).slice(-2)}`;

            let html = `<html><head><title>‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ_${dateStr}</title>`;
            html += `<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">`;
            html += `<style>body { font-family: 'Sarabun', sans-serif; padding: 20px; color:#333; } h2 { text-align: center; margin-bottom: 5px; } .meta { text-align: center; font-size: 14px; margin-bottom: 20px; color: #555; } table { width: 100%; border-collapse: collapse; font-size: 12px; } th { background: #eee; padding: 8px; border: 1px solid #999; text-align: center; font-weight:bold; } td { padding: 6px; border: 1px solid #999; vertical-align: middle; } .text-right { text-align: right; } .text-center { text-align: center; } .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; color: white; display: inline-block;} .bg-green { background: #27ae60; color:white; } .bg-red { background: #c0392b; color:white; } .bg-purple { background: #8e44ad; color:white; } .bg-orange { background: #f39c12; color:white; } @media print { button { display: none; } @page { size: A4 landscape; margin: 10mm; } } </style></head><body>`;
            html += `<h2>üìë ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>`;
            html += `<div class="meta">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <b>${dateStr}</b> | ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤ ${printTime} ‡∏ô. | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${filteredData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
            html += `<table><thead><tr><th width="5%">#</th><th width="10%">‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th width="15%">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th width="10%">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th width="8%">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà</th><th width="10%">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</th><th width="12%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th width="30%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</th></tr></thead><tbody>`;

            filteredData.forEach((item, index) => {
                let statusBadge = "";
                if (item.status === 'Pending_Approve' || item.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') statusBadge = `<span class="badge bg-orange">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>`;
                else if (item.status === '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î') statusBadge = `<span class="badge bg-orange">‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</span>`;
                else if (item.postpone_date && item.postpone_date !== '-') statusBadge = `<span class="badge bg-purple">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô: ${item.postpone_date}</span>`;
                else if (item.overdue_count > 0) statusBadge = `<span class="badge bg-red">‡∏Ñ‡πâ‡∏≤‡∏á ${item.overdue_count} ‡∏á‡∏ß‡∏î</span>`;
                else statusBadge = `<span class="badge bg-green">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;

                let note = item.last_note || "";
                note = note.replace(/(https?:\/\/[^\s]+)/g, '[‡∏£‡∏π‡∏õ/‡∏•‡∏¥‡∏á‡∏Å‡πå]');

                html += `<tr><td class="text-center">${index + 1}</td><td class="text-center">${item.c_no}</td><td>${item.b_name}</td><td class="text-center">${item.b_mobile}</td><td class="text-center">${item.installment_no}</td><td class="text-right">${parseFloat(item.finalAmount).toLocaleString()}</td><td class="text-center">${statusBadge}</td><td>${note}</td></tr>`;
            });

            html += `</tbody></table>`;
            html += `<div style="margin-top:20px; font-size:12px; text-align:right;">‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${currentUser ? currentUser.name : '-'}</div>`;
            html += `<div style="text-align:center; margin-top:20px;"><button onclick="window.print()" style="padding:10px 20px; cursor:pointer;">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button></div></body></html>`;

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
        }
    </script>
</body>
</html>