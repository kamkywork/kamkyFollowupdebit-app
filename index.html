<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î - Collection Dashboard (Final Fixed)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
        .header { background: #2c3e50; color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header h2 { margin: 0; font-size: 18px; }
        .date-picker-container { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
        .date-picker-container input { flex: 1; padding: 8px; border-radius: 4px; border: none; min-width: 120px; }
        .btn-tool { border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px; color: white; transition: 0.2s; font-size: 13px; }
        .btn-refresh { background: #f39c12; }
        .btn-print { background: #34495e; }
        .btn-excel { background: #27ae60; }
        .btn-reset-hide { background: #95a5a6; }
        .btn-report-daily { background: #e74c3c; } 
        .btn-report-monthly { background: #8e44ad; }
        .btn-tool:hover { filter: brightness(1.1); }
        .perf-container { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .perf-container { grid-template-columns: 1fr; } }
        .perf-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; }
        .perf-title { font-size: 14px; color: #7f8c8d; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .chart-wrapper { position: relative; height: 150px; width: 100%; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
        .perf-detail { display: flex; justify-content: space-between; font-size: 13px; color: #555; background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .list-container { padding: 15px; }
        .customer-card { background: white; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; position: relative; }
        .card-banner { padding: 8px 15px; color: white; font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .banner-dark-red { background: linear-gradient(135deg, #b71c1c 0%, #d32f2f 100%); }
        .banner-red { background: #c0392b; }      
        .banner-orange { background: #e67e22; }   
        .banner-yellow { background: #f1c40f; color: #2c3e50; } 
        .banner-purple { background: #8e44ad; }   
        .btn-menu-card { background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; margin-left: 10px; }
        .card-content { padding: 15px; }
        .cust-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .cust-name { font-weight: bold; font-size: 16px; color: #2c3e50; }
        .cust-id { font-size: 12px; color: #7f8c8d; background: #ecf0f1; padding: 2px 8px; border-radius: 10px; }
        .amount-highlight { font-size: 24px; font-weight: bold; color: #2c3e50; margin: 15px 0 10px; text-align: right; border-top: 1px dashed #eee; padding-top: 10px; }
        .action-bar { display: flex; gap: 10px; margin-top: 10px; }
        .btn-action { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-pay { background: #27ae60; color: white; }
        .btn-postpone { background: #95a5a6; color: white; }
        .btn-call { background: #3498db; color: white; text-decoration: none; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .report-table th, .report-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .report-table th { background: #f8f9fa; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>üìä Dashboard ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ</h2>
            <span id="currentTime" style="font-size:12px; opacity:0.8;"></span>
        </div>
        
        <div class="date-picker-container">
            <input type="date" id="filterDate" onchange="loadData()">
            <button class="btn-tool btn-refresh" onclick="loadData()"><i class="fas fa-sync-alt"></i></button>
            <button class="btn-tool btn-report-daily" onclick="showSummary('daily')"><i class="fas fa-image"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô</button>
            <button class="btn-tool btn-report-monthly" onclick="showSummary('monthly')"><i class="fas fa-chart-line"></i> ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            <button class="btn-tool btn-print" onclick="printReport()"><i class="fas fa-print"></i> ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</button>
            <button class="btn-tool btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i></button>
            <button class="btn-tool btn-reset-hide" onclick="resetHidden()"><i class="fas fa-eye"></i></button>
        </div>
    </div>

    <div class="perf-container">
        <div class="perf-card">
            <div class="perf-title"><span><i class="fas fa-calendar-day"></i> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><span id="txtTodayPercent" style="font-weight:bold; color:#27ae60;">0%</span></div>
            <div class="chart-wrapper"><canvas id="dailyChart"></canvas></div>
            <div class="perf-detail">
                <div><span style="font-size:10px; display:block; color:#aaa;">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</span><b id="txtTodayCollected">0</b></div>
                <div style="text-align:right;"><span style="font-size:10px; display:block; color:#aaa;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span><b id="txtTodayPending">0</b></div>
            </div>
        </div>

        <div class="perf-card">
            <div class="perf-title"><span><i class="fas fa-calendar-alt"></i> ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span><span id="txtMonthPercent" style="font-weight:bold; color:#3498db;">0%</span></div>
            <div class="chart-wrapper"><canvas id="monthlyChart"></canvas></div>
            <div class="perf-detail">
                <div><span style="font-size:10px; display:block; color:#aaa;">‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏∞‡∏™‡∏°</span><b id="txtMonthCollected">0</b></div>
                <div style="text-align:right;"><span style="font-size:10px; display:block; color:#aaa;">‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span><b id="txtMonthTarget">0</b></div>
            </div>
        </div>
    </div>

    <div class="list-container" id="contractList"></div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxwv-zrFtI-CFSkAtK5NnLfsAnc5n4gWIkXYICUnKfhUG6twkyE6hvKNlGqTFQ288xW/exec'; 

        let currentTrackingData = [];
        let filteredData = []; 
        let globalSummary = {};
        let dailyChartInstance = null;
        let monthlyChartInstance = null;

        document.getElementById('filterDate').valueAsDate = new Date();

        function formatDateToThai(dateString) {
            if(!dateString) return "";
            const p = dateString.split('-');
            return `${p[2]}/${p[1]}/${p[0]}`; 
        }

        async function loadData() {
            const date = document.getElementById('filterDate').value;
            const container = document.getElementById('contractList');
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

            try {
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'get_tracking', date: date }) });
                const data = await response.json();
                currentTrackingData = data.contracts || [];
                globalSummary = data.summary || {};
                renderDashboard(data, date);
            } catch (e) {
                container.innerHTML = '<div style="color:red; text-align:center;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
            }
        }

        function renderDashboard(data, selectedDate) {
            const container = document.getElementById('contractList');
            container.innerHTML = "";
            const hidden = JSON.parse(localStorage.getItem('hiddenContracts') || '[]').map(String);
            const selectedDateThai = formatDateToThai(selectedDate);
            
            filteredData = [];
            let pendingToday = 0;

            if (data.contracts) {
                data.contracts.forEach(c => {
                    if (hidden.includes(String(c.c_no))) return;
                    const hasPost = (c.postpone_date && c.postpone_date !== "-" && c.postpone_date !== "");
                    let show = (hasPost && c.postpone_date === selectedDateThai) || (!hasPost && (c.due_date === selectedDateThai || c.overdue_count > 0));
                    
                    if (show) {
                        let amt = parseFloat(c.amount) * (c.overdue_count > 1 ? c.overdue_count : 1);
                        pendingToday += amt;
                        filteredData.push({ ...c, finalAmount: amt, hasPostpone: hasPost });
                    }
                });
            }

            const colToday = data.summary.total_collected_today || 0;
            const targetToday = colToday + pendingToday;
            updateChart('dailyChart', 'daily', colToday, pendingToday);
            document.getElementById('txtTodayCollected').innerText = colToday.toLocaleString();
            document.getElementById('txtTodayPending').innerText = pendingToday.toLocaleString();
            document.getElementById('txtTodayPercent').innerText = `${Math.round(targetToday > 0 ? (colToday/targetToday)*100 : 0)}%`;

            const colMonth = data.summary.total_collected_month || 0;
            const targetMonth = data.summary.expected_month || data.summary.total_expected_month || 0;
            updateChart('monthlyChart', 'monthly', colMonth, Math.max(0, targetMonth - colMonth));
            document.getElementById('txtMonthCollected').innerText = colMonth.toLocaleString();
            document.getElementById('txtMonthTarget').innerText = targetMonth.toLocaleString();
            document.getElementById('txtMonthPercent').innerText = `${Math.round(targetMonth > 0 ? (colMonth/targetMonth)*100 : 0)}%`;

            if (filteredData.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>';
                return;
            }

            filteredData.forEach(c => {
                let banner = c.overdue_count > 1 ? "banner-dark-red" : (c.overdue_count > 0 ? "banner-red" : "banner-yellow");
                if (c.hasPostpone) banner = "banner-purple";

                container.innerHTML += `
                <div class="customer-card">
                    <div class="card-banner ${banner}">
                        <span>${c.hasPostpone ? '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î: '+c.postpone_date : c.status}</span>
                        <button class="btn-menu-card" onclick="openManageMenu(${c.row_index},'${c.b_name}','${c.c_no}')"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                    <div class="card-content">
                        <div class="cust-row"><div class="cust-name">${c.b_name}</div><div class="cust-id">${c.c_no}</div></div>
                        <div style="font-size:14px; color:#555; margin-bottom:5px;"><i class="fas fa-phone"></i> ${c.b_mobile || '-'}</div>
                        <div class="amount-highlight">‡∏ø ${c.finalAmount.toLocaleString()}</div>
                        <div class="action-bar">
                            <a href="tel:${c.b_mobile}" class="btn-action btn-call"><i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£</a>
                            <button class="btn-action btn-postpone" onclick="openPostpone(${c.row_index},'${c.b_name}','${c.postpone_date||''}')"><i class="fas fa-clock"></i> ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</button>
                            <button class="btn-action btn-pay" onclick="openPay('${c.c_no}')"><i class="fas fa-wallet"></i> ‡∏à‡πà‡∏≤‡∏¢</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        function updateChart(canvasId, type, collected, remaining) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            let colors = type === 'daily' ? ['#27ae60', '#e74c3c'] : ['#3498db', '#ecf0f1'];
            if (collected === 0 && remaining === 0) { remaining = 1; colors = ['#ecf0f1','#ecf0f1']; }

            const config = {
                type: 'doughnut',
                data: { labels: ['‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'], datasets: [{ data: [collected, remaining], backgroundColor: colors, borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } }
            };

            if (type === 'daily') { if (dailyChartInstance) dailyChartInstance.destroy(); dailyChartInstance = new Chart(ctx, config); }
            else { if (monthlyChartInstance) monthlyChartInstance.destroy(); monthlyChartInstance = new Chart(ctx, config); }
        }

        function showSummary(type) {
            let col = type === 'daily' ? (globalSummary.total_collected_today || 0) : (globalSummary.total_collected_month || 0);
            let target = type === 'daily' ? (col + filteredData.reduce((a,b)=>a+b.finalAmount,0)) : (globalSummary.expected_month || globalSummary.total_expected_month || 0);
            let percent = target > 0 ? (col/target*100).toFixed(1) : 0;

            Swal.fire({
                title: type === 'daily' ? 'üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' : 'üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                html: `
                    <table class="report-table">
                        <tr><td>‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß</td><td align="right"><b>${col.toLocaleString()}</b></td></tr>
                        <tr><td>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡πÄ‡∏õ‡πâ‡∏≤</td><td align="right"><b>${(target-col).toLocaleString()}</b></td></tr>
                        <tr style="border-top:2px solid #333"><td>‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</td><td align="right"><b>${target.toLocaleString()}</b></td></tr>
                    </table>
                    <div style="margin-top:15px; font-size:20px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <b style="color:#27ae60">${percent}%</b></div>
                `,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-image"></i> ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô JPG',
                confirmButtonColor: '#3498db',
                cancelButtonText: '‡∏õ‡∏¥‡∏î'
            }).then(r => { if(r.isConfirmed) printSummaryReport(type, col, target, percent); });
        }

        function printSummaryReport(type, col, target, percent) {
            const canvas = document.getElementById(type === 'daily' ? 'dailyChart' : 'monthlyChart');
            const chartImg = canvas.toDataURL("image/png");
            const dateStr = formatDateToThai(document.getElementById('filterDate').value);

            let win = window.open('', '', 'height=850,width=900');
            win.document.write(`
                <html><head><title>Report Summary</title><link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
                <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"><\/script>
                <style>
                    body{font-family:'Sarabun',sans-serif; padding:40px; background: #ffffff;} #reportContent{padding:20px; border:1px solid #ddd; border-radius:10px; background:white;}
                    .header{text-align:center; border-bottom:3px solid #2c3e50; padding-bottom:10px; margin-bottom: 20px;}
                    .content{display:flex; justify-content:space-between; align-items:center;} .table{width:55%; border-collapse:collapse;}
                    .table td, .table th{padding:12px; border:1px solid #ddd; font-size:16px;} .chart{width:40%; text-align:center;}
                    .btn-group{text-align:center; margin-top:30px;} .btn{padding:10px 25px; border:none; border-radius:5px; cursor:pointer; color:white; font-weight:bold; margin:0 10px; font-size:16px;}
                    .btn-pdf{background:#27ae60;} .btn-jpg{background:#3498db;} @media print{.no-print{display:none;}}
                </style></head>
                <body>
                    <div id="reportContent">
                        <div class="header"><h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô${type==='daily'?'‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô':'‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'}</h2><p>‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr}</p></div>
                        <div class="content">
                            <table class="table">
                                <tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th></tr>
                                <tr><td>‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á</td><td align="right" style="color:#27ae60;">${col.toLocaleString()}</td></tr>
                                <tr><td>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</td><td align="right" style="color:#e74c3c;">${(target-col).toLocaleString()}</td></tr>
                                <tr style="background:#f8f9fa;"><td><b>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏ß‡∏°</b></td><td align="right"><b>${target.toLocaleString()}</b></td></tr>
                                <tr><td><b>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</b></td><td align="right"><b>${percent}%</b></td></tr>
                            </table>
                            <div class="chart"><img src="${chartImg}" style="width:220px;"><p style="font-size:12px; color:#666;">‡πÅ‡∏ú‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</p></div>
                        </div>
                    </div>
                    <div class="no-print btn-group">
                        <button class="btn btn-pdf" onclick="window.print()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>
                        <button class="btn btn-jpg" onclick="saveAsJPG()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (.JPG)</button>
                    </div>
                    <script>
                        function saveAsJPG() {
                            const element = document.getElementById('reportContent');
                            html2canvas(element, { scale: 3, backgroundColor: "#ffffff", useCORS: true }).then(canvas => {
                                const link = document.createElement('a');
                                link.download = 'Report_${type}_' + '${dateStr}'.replace(/\\//g,'-') + '.jpg';
                                link.href = canvas.toDataURL("image/jpeg", 0.9);
                                link.click();
                            });
                        }
                    <\/script>
                </body></html>
            `);
            win.document.close();
        }

        function printReport() {
            if (!filteredData || filteredData.length === 0) { Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', 'info'); return; }
            const selectDate = document.getElementById('filterDate').value;
            const dateParts = selectDate.split('-');
            const thaiDate = `${dateParts[2]}/${dateParts[1]}/${parseInt(dateParts[0])+543}`;
            let printWindow = window.open('', '', 'height=800,width=1000');
            let tableRows = '';
            let totalAmount = 0;
            
            filteredData.forEach((item, index) => {
                totalAmount += item.finalAmount;
                
                // --- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå ---
                let statusLabel = "";
                let colorStyle = "";

                if (item.hasPostpone) {
                    statusLabel = "‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏ä‡∏≥‡∏£‡∏∞";
                    colorStyle = "color: #8e44ad; font-weight: bold;"; // ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á
                } else if (item.overdue_count > 0) {
                    statusLabel = "‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ (" + item.overdue_count + " ‡∏á‡∏ß‡∏î)";
                    colorStyle = "color: #c0392b; font-weight: bold;"; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                } else {
                    statusLabel = "‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞";
                    colorStyle = "color: #2c3e50;"; // ‡∏™‡∏µ‡∏î‡∏≥‡∏õ‡∏Å‡∏ï‡∏¥
                }
                
                tableRows += `
                <tr>
                    <td style="text-align:center;">${index + 1}</td>
                    <td style="text-align:center;">${item.c_no}</td>
                    <td><b>${item.b_name}</b><br>${item.b_mobile||'-'}</td>
                    <td style="text-align:center;">${item.installment_no}</td>
                    <td style="text-align:right;">${item.finalAmount.toLocaleString()}</td>
                    <td style="text-align:center; ${colorStyle}">${statusLabel}</td>
                    <td style="border-bottom:1px solid #ddd;"></td>
                </tr>`;
            });
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ</title>
                    <style>
                        body{font-family:'Sarabun',sans-serif; padding:20px;} 
                        table{width:100%; border-collapse:collapse;} 
                        th,td{border:1px solid #000; padding:8px; vertical-align:middle;} 
                        th{background:#f2f2f2;} 
                        h2{text-align:center; margin-bottom: 5px;}
                        .sub-head{text-align:center; margin-bottom: 20px; font-size: 14px; color: #555;}
                    </style>
                </head>
                <body>
                    <h2>‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ</h2>
                    <div class="sub-head">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${thaiDate} (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ${new Date().toLocaleTimeString('th-TH')} ‡∏ô.)</div>
                    <table>
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="15%">‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                                <th width="25%">‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                                <th width="5%">‡∏á‡∏ß‡∏î</th>
                                <th width="15%">‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡πá‡∏ö</th>
                                <th width="20%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" align="right"><b>‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö</b></td>
                                <td align="right"><b>${totalAmount.toLocaleString()}</b></td>
                                <td colspan="2">‡∏ö‡∏≤‡∏ó</td>
                            </tr>
                        </tfoot>
                    </table>
                    <script>window.print();<\/script>
                </body>
                </html>`);
            printWindow.document.close();
        }

        function exportToExcel() {
            if (!filteredData.length) { Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', 'info'); return; }
            let csv = "data:text/csv;charset=utf-8,\uFEFF‡∏•‡∏≥‡∏î‡∏±‡∏ö,‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏ä‡∏∑‡πà‡∏≠,‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏á‡∏ß‡∏î,‡∏¢‡∏≠‡∏î,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n";
            filteredData.forEach((i, idx) => csv += (idx+1) + ',"' + i.c_no + '","' + i.b_name + '","' + i.b_mobile + '",' + i.installment_no + ',' + i.finalAmount + ',"' + i.status + '"\n');
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "Tracking_Report.csv"; link.click();
        }

        function openPay(c_no) { window.open(`https://kamkywork.github.io/kamkybill-app/?ref=${c_no}`, '_blank'); }
        function hideContract(c_no) {
            let h = JSON.parse(localStorage.getItem('hiddenContracts') || '[]');
            if(!h.includes(String(c_no))) { h.push(String(c_no)); localStorage.setItem('hiddenContracts', JSON.stringify(h)); loadData(); }
        }
        function resetHidden() { localStorage.removeItem('hiddenContracts'); loadData(); }
        
        function openManageMenu(idx, name, c_no) {
            Swal.fire({
                title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤', html: `<b>${name}</b> (${c_no})`, icon: 'info',
                showCancelButton: true, confirmButtonText: '<i class="fas fa-eye-slash"></i> ‡∏ã‡πà‡∏≠‡∏ô', confirmButtonColor: '#7f8c8d', cancelButtonText: '‡∏õ‡∏¥‡∏î'
            }).then((result) => { if (result.isConfirmed) hideContract(c_no); });
        }

        function openPostpone(idx, name, cur) {
            Swal.fire({ title: '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà', input: 'date', showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' }).then(r => {
                if(r.isConfirmed && r.value) executeAction({ action: 'postpone', row_index: idx, new_date: r.value });
            });
        }
        
        async function executeAction(p) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
            try {
                await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(p) });
                Swal.fire({ icon: 'success', title: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false });
                loadData();
            } catch (e) { Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
        }

        window.onload = loadData;
    </script>
</body>
</html>